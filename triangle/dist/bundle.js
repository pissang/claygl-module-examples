!function(t){var e={};function r(n){if(e[n])return e[n].exports;var i=e[n]={i:n,l:!1,exports:{}};return t[n].call(i.exports,i,i.exports,r),i.l=!0,i.exports}r.m=t,r.c=e,r.d=function(t,e,n){r.o(t,e)||Object.defineProperty(t,e,{configurable:!1,enumerable:!0,get:n})},r.r=function(t){Object.defineProperty(t,"__esModule",{value:!0})},r.n=function(t){var e=t&&t.__esModule?function(){return t.default}:function(){return t};return r.d(e,"a",e),e},r.o=function(t,e){return Object.prototype.hasOwnProperty.call(t,e)},r.p="",r(r.s=1)}([function(t,e,r){"use strict";function n(t,e,r){"object"==typeof e&&(r=e,e=null);var n,a=this;if(!(t instanceof Function))for(var s in n=[],t)t.hasOwnProperty(s)&&n.push(s);var o=function(e){if(a.apply(this,arguments),t instanceof Function?i(this,t.call(this,e)):function(t,e,r){for(var n=0;n<r.length;n++){var i=r[n];t[i]=e[i]}}(this,t,n),this.constructor===o)for(var r=o.__initializers__,s=0;s<r.length;s++)r[s].apply(this,arguments)};o.__super__=a,a.__initializers__?o.__initializers__=a.__initializers__.slice():o.__initializers__=[],e&&o.__initializers__.push(e);var u=function(){};return u.prototype=a.prototype,o.prototype=new u,o.prototype.constructor=o,i(o.prototype,r),o.extend=a.extend,o.derive=a.extend,o}function i(t,e){if(e)for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r])}r.r(e);var a={extend:n,derive:n};var s={trigger:function(t){if(this.hasOwnProperty("__handlers__")&&this.__handlers__.hasOwnProperty(t)){var e=this.__handlers__[t],r=e.length,n=-1,i=arguments;switch(i.length){case 1:for(;++n<r;)e[n].action.call(e[n].context);return;case 2:for(;++n<r;)e[n].action.call(e[n].context,i[1]);return;case 3:for(;++n<r;)e[n].action.call(e[n].context,i[1],i[2]);return;case 4:for(;++n<r;)e[n].action.call(e[n].context,i[1],i[2],i[3]);return;case 5:for(;++n<r;)e[n].action.call(e[n].context,i[1],i[2],i[3],i[4]);return;default:for(;++n<r;)e[n].action.apply(e[n].context,Array.prototype.slice.call(i,1));return}}},on:function(t,e,r){if(t&&e){var n=this.__handlers__||(this.__handlers__={});if(n[t]){if(this.has(t,e))return}else n[t]=[];var i=new function(t,e){this.action=t,this.context=e}(e,r||this);return n[t].push(i),this}},once:function(t,e,r){if(t&&e){var n=this;return this.on(t,function r(){n.off(t,r),e.apply(this,arguments)},r)}},before:function(t,e,r){if(t&&e)return t="before"+t,this.on(t,e,r)},after:function(t,e,r){if(t&&e)return t="after"+t,this.on(t,e,r)},success:function(t,e){return this.once("success",t,e)},error:function(t,e){return this.once("error",t,e)},off:function(t,e){var r=this.__handlers__||(this.__handlers__={});if(e){if(r[t]){for(var n=r[t],i=[],a=0;a<n.length;a++)e&&n[a].action!==e&&i.push(n[a]);r[t]=i}return this}r[t]=[]},has:function(t,e){var r=this.__handlers__;if(!r||!r[t])return!1;for(var n=r[t],i=0;i<n.length;i++)if(n[i].action===e)return!0}},o=0,u=Array.prototype.forEach,f={genGUID:function(){return++o},relative2absolute:function(t,e){if(!e||t.match(/^\//))return t;for(var r=t.split("/"),n=e.split("/"),i=r[0];"."===i||".."===i;)".."===i&&n.pop(),r.shift(),i=r[0];return n.join("/")+"/"+r.join("/")},extend:function(t,e){if(e)for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r]);return t},defaults:function(t,e){if(e)for(var r in e)void 0===t[r]&&(t[r]=e[r]);return t},extendWithPropList:function(t,e,r){if(e)for(var n=0;n<r.length;n++){var i=r[n];t[i]=e[i]}return t},defaultsWithPropList:function(t,e,r){if(e)for(var n=0;n<r.length;n++){var i=r[n];null==t[i]&&(t[i]=e[i])}return t},each:function(t,e,r){if(t&&e)if(t.forEach&&t.forEach===u)t.forEach(e,r);else if(t.length===+t.length)for(var n=0,i=t.length;n<i;n++)e.call(r,t[n],n,t);else for(var a in t)t.hasOwnProperty(a)&&e.call(r,t[a],a,t)},isObject:function(t){return t===Object(t)},isArray:function(t){return Array.isArray(t)},isArrayLike:function(t){return!!t&&t.length===+t.length},clone:function(t){if(f.isObject(t)){if(f.isArray(t))return t.slice();if(f.isArrayLike(t)){for(var e=new t.constructor(t.length),r=0;r<t.length;r++)e[r]=t[r];return e}return f.extend({},t)}return t}},h=f,l=function(){this.__uid__=h.genGUID()};l.__initializers__=[function(t){h.extend(this,t)}],h.extend(l,a),h.extend(l.prototype,s);var c=l,d=["OES_texture_float","OES_texture_half_float","OES_texture_float_linear","OES_texture_half_float_linear","OES_standard_derivatives","OES_vertex_array_object","OES_element_index_uint","WEBGL_compressed_texture_s3tc","WEBGL_depth_texture","EXT_texture_filter_anisotropic","EXT_shader_texture_lod","WEBGL_draw_buffers","EXT_frag_depth","EXT_sRGB"],_=["MAX_TEXTURE_SIZE","MAX_CUBE_MAP_TEXTURE_SIZE"];var v=function(t){for(var e={},r={},n=0;n<d.length;n++)a(d[n]);for(n=0;n<_.length;n++){var i=_[n];r[i]=t.getParameter(t[i])}function a(r){var n=t.getExtension(r);n||(n=t.getExtension("MOZ_"+r)),n||(n=t.getExtension("WEBKIT_"+r)),e[r]=n}this.getExtension=function(t){return t in e||a(t),e[t]},this.getParameter=function(t){return r[t]},this.getMaxJointNumber=function(){return 15}},p=256,m=1024,y=16384,g=35040,b=35044,E=35048,x=5120,S=5121,O=5122,R=5123,A=5126,I=function(){this.head=null,this.tail=null,this._length=0};I.prototype.insert=function(t){var e=new I.Entry(t);return this.insertEntry(e),e},I.prototype.insertAt=function(t,e){if(!(t<0)){for(var r=this.head,n=0;r&&n!=t;)r=r.next,n++;if(r){var i=new I.Entry(e),a=r.prev;a?(a.next=i,i.prev=a):this.head=i,i.next=r,r.prev=i}else this.insert(e)}},I.prototype.insertBeforeEntry=function(t,e){var r=new I.Entry(t),n=e.prev;n?(n.next=r,r.prev=n):this.head=r,r.next=e,e.prev=r,this._length++},I.prototype.insertEntry=function(t){this.head?(this.tail.next=t,t.prev=this.tail,this.tail=t):this.head=this.tail=t,this._length++},I.prototype.remove=function(t){var e=t.prev,r=t.next;e?e.next=r:this.head=r,r?r.prev=e:this.tail=e,t.next=t.prev=null,this._length--},I.prototype.removeAt=function(t){if(!(t<0)){for(var e=this.head,r=0;e&&r!=t;)e=e.next,r++;return e?(this.remove(e),e.value):void 0}},I.prototype.getHead=function(){if(this.head)return this.head.value},I.prototype.getTail=function(){if(this.tail)return this.tail.value},I.prototype.getAt=function(t){if(!(t<0)){for(var e=this.head,r=0;e&&r!=t;)e=e.next,r++;return e.value}},I.prototype.indexOf=function(t){for(var e=this.head,r=0;e;){if(e.value===t)return r;e=e.next,r++}},I.prototype.length=function(){return this._length},I.prototype.isEmpty=function(){return 0===this._length},I.prototype.forEach=function(t,e){for(var r=this.head,n=0,i=void 0!==e;r;)i?t.call(e,r.value,n):t(r.value,n),r=r.next,n++},I.prototype.clear=function(){this.tail=this.head=null,this._length=0},I.Entry=function(t){this.value=t,this.next=null,this.prev=null};var T=I,M=function(t){this._list=new T,this._map={},this._maxSize=t||10};M.prototype.setMaxSize=function(t){this._maxSize=t},M.prototype.put=function(t,e){if(!this._map.hasOwnProperty(t)){var r=this._list.length();if(r>=this._maxSize&&r>0){var n=this._list.head;this._list.remove(n),delete this._map[n.key]}var i=this._list.insert(e);i.key=t,this._map[t]=i}},M.prototype.get=function(t){var e=this._map[t];if(this._map.hasOwnProperty(t))return e!==this._list.tail&&(this._list.remove(e),this._list.insertEntry(e)),e.value},M.prototype.remove=function(t){var e=this._map[t];void 0!==e&&(delete this._map[t],this._list.remove(e))},M.prototype.clear=function(){this._list.clear(),this._map={}};var w={},N={transparent:[0,0,0,0],aliceblue:[240,248,255,1],antiquewhite:[250,235,215,1],aqua:[0,255,255,1],aquamarine:[127,255,212,1],azure:[240,255,255,1],beige:[245,245,220,1],bisque:[255,228,196,1],black:[0,0,0,1],blanchedalmond:[255,235,205,1],blue:[0,0,255,1],blueviolet:[138,43,226,1],brown:[165,42,42,1],burlywood:[222,184,135,1],cadetblue:[95,158,160,1],chartreuse:[127,255,0,1],chocolate:[210,105,30,1],coral:[255,127,80,1],cornflowerblue:[100,149,237,1],cornsilk:[255,248,220,1],crimson:[220,20,60,1],cyan:[0,255,255,1],darkblue:[0,0,139,1],darkcyan:[0,139,139,1],darkgoldenrod:[184,134,11,1],darkgray:[169,169,169,1],darkgreen:[0,100,0,1],darkgrey:[169,169,169,1],darkkhaki:[189,183,107,1],darkmagenta:[139,0,139,1],darkolivegreen:[85,107,47,1],darkorange:[255,140,0,1],darkorchid:[153,50,204,1],darkred:[139,0,0,1],darksalmon:[233,150,122,1],darkseagreen:[143,188,143,1],darkslateblue:[72,61,139,1],darkslategray:[47,79,79,1],darkslategrey:[47,79,79,1],darkturquoise:[0,206,209,1],darkviolet:[148,0,211,1],deeppink:[255,20,147,1],deepskyblue:[0,191,255,1],dimgray:[105,105,105,1],dimgrey:[105,105,105,1],dodgerblue:[30,144,255,1],firebrick:[178,34,34,1],floralwhite:[255,250,240,1],forestgreen:[34,139,34,1],fuchsia:[255,0,255,1],gainsboro:[220,220,220,1],ghostwhite:[248,248,255,1],gold:[255,215,0,1],goldenrod:[218,165,32,1],gray:[128,128,128,1],green:[0,128,0,1],greenyellow:[173,255,47,1],grey:[128,128,128,1],honeydew:[240,255,240,1],hotpink:[255,105,180,1],indianred:[205,92,92,1],indigo:[75,0,130,1],ivory:[255,255,240,1],khaki:[240,230,140,1],lavender:[230,230,250,1],lavenderblush:[255,240,245,1],lawngreen:[124,252,0,1],lemonchiffon:[255,250,205,1],lightblue:[173,216,230,1],lightcoral:[240,128,128,1],lightcyan:[224,255,255,1],lightgoldenrodyellow:[250,250,210,1],lightgray:[211,211,211,1],lightgreen:[144,238,144,1],lightgrey:[211,211,211,1],lightpink:[255,182,193,1],lightsalmon:[255,160,122,1],lightseagreen:[32,178,170,1],lightskyblue:[135,206,250,1],lightslategray:[119,136,153,1],lightslategrey:[119,136,153,1],lightsteelblue:[176,196,222,1],lightyellow:[255,255,224,1],lime:[0,255,0,1],limegreen:[50,205,50,1],linen:[250,240,230,1],magenta:[255,0,255,1],maroon:[128,0,0,1],mediumaquamarine:[102,205,170,1],mediumblue:[0,0,205,1],mediumorchid:[186,85,211,1],mediumpurple:[147,112,219,1],mediumseagreen:[60,179,113,1],mediumslateblue:[123,104,238,1],mediumspringgreen:[0,250,154,1],mediumturquoise:[72,209,204,1],mediumvioletred:[199,21,133,1],midnightblue:[25,25,112,1],mintcream:[245,255,250,1],mistyrose:[255,228,225,1],moccasin:[255,228,181,1],navajowhite:[255,222,173,1],navy:[0,0,128,1],oldlace:[253,245,230,1],olive:[128,128,0,1],olivedrab:[107,142,35,1],orange:[255,165,0,1],orangered:[255,69,0,1],orchid:[218,112,214,1],palegoldenrod:[238,232,170,1],palegreen:[152,251,152,1],paleturquoise:[175,238,238,1],palevioletred:[219,112,147,1],papayawhip:[255,239,213,1],peachpuff:[255,218,185,1],peru:[205,133,63,1],pink:[255,192,203,1],plum:[221,160,221,1],powderblue:[176,224,230,1],purple:[128,0,128,1],red:[255,0,0,1],rosybrown:[188,143,143,1],royalblue:[65,105,225,1],saddlebrown:[139,69,19,1],salmon:[250,128,114,1],sandybrown:[244,164,96,1],seagreen:[46,139,87,1],seashell:[255,245,238,1],sienna:[160,82,45,1],silver:[192,192,192,1],skyblue:[135,206,235,1],slateblue:[106,90,205,1],slategray:[112,128,144,1],slategrey:[112,128,144,1],snow:[255,250,250,1],springgreen:[0,255,127,1],steelblue:[70,130,180,1],tan:[210,180,140,1],teal:[0,128,128,1],thistle:[216,191,216,1],tomato:[255,99,71,1],turquoise:[64,224,208,1],violet:[238,130,238,1],wheat:[245,222,179,1],white:[255,255,255,1],whitesmoke:[245,245,245,1],yellow:[255,255,0,1],yellowgreen:[154,205,50,1]};function P(t){return(t=Math.round(t))<0?0:t>255?255:t}function C(t){return t<0?0:t>1?1:t}function D(t){return t.length&&"%"===t.charAt(t.length-1)?P(parseFloat(t)/100*255):P(parseInt(t,10))}function k(t){return t.length&&"%"===t.charAt(t.length-1)?C(parseFloat(t)/100):C(parseFloat(t))}function L(t,e,r){return r<0?r+=1:r>1&&(r-=1),6*r<1?t+(e-t)*r*6:2*r<1?e:3*r<2?t+(e-t)*(2/3-r)*6:t}function U(t,e,r){return t+(e-t)*r}function V(t,e,r,n,i){return t[0]=e,t[1]=r,t[2]=n,t[3]=i,t}function W(t,e){return t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],t}var B=new M(20),F=null;function j(t,e){F&&W(F,e),F=B.put(t,F||e.slice())}function q(t,e){var r=(parseFloat(t[0])%360+360)%360/360,n=k(t[1]),i=k(t[2]),a=i<=.5?i*(n+1):i+n-i*n,s=2*i-a;return V(e=e||[],P(255*L(s,a,r+1/3)),P(255*L(s,a,r)),P(255*L(s,a,r-1/3)),1),4===t.length&&(e[3]=t[3]),e}w.parse=function(t,e){if(t){e=e||[];var r=B.get(t);if(r)return W(e,r);var n,i=(t+="").replace(/ /g,"").toLowerCase();if(i in N)return W(e,N[i]),j(t,e),e;if("#"===i.charAt(0))return 4===i.length?(n=parseInt(i.substr(1),16))>=0&&n<=4095?(V(e,(3840&n)>>4|(3840&n)>>8,240&n|(240&n)>>4,15&n|(15&n)<<4,1),j(t,e),e):void V(e,0,0,0,1):7===i.length?(n=parseInt(i.substr(1),16))>=0&&n<=16777215?(V(e,(16711680&n)>>16,(65280&n)>>8,255&n,1),j(t,e),e):void V(e,0,0,0,1):void 0;var a=i.indexOf("("),s=i.indexOf(")");if(-1!==a&&s+1===i.length){var o=i.substr(0,a),u=i.substr(a+1,s-(a+1)).split(","),f=1;switch(o){case"rgba":if(4!==u.length)return void V(e,0,0,0,1);f=k(u.pop());case"rgb":return 3!==u.length?void V(e,0,0,0,1):(V(e,D(u[0]),D(u[1]),D(u[2]),f),j(t,e),e);case"hsla":return 4!==u.length?void V(e,0,0,0,1):(u[3]=k(u[3]),q(u,e),j(t,e),e);case"hsl":return 3!==u.length?void V(e,0,0,0,1):(q(u,e),j(t,e),e);default:return}}V(e,0,0,0,1)}},w.parseToFloat=function(t,e){if(e=w.parse(t,e))return e[0]/=255,e[1]/=255,e[2]/=255,e},w.lift=function(t,e){var r=w.parse(t);if(r){for(var n=0;n<3;n++)r[n]=e<0?r[n]*(1-e)|0:(255-r[n])*e+r[n]|0;return w.stringify(r,4===r.length?"rgba":"rgb")}},w.toHex=function(t){var e=w.parse(t);if(e)return((1<<24)+(e[0]<<16)+(e[1]<<8)+ +e[2]).toString(16).slice(1)},w.fastLerp=function(t,e,r){if(e&&e.length&&t>=0&&t<=1){r=r||[];var n=t*(e.length-1),i=Math.floor(n),a=Math.ceil(n),s=e[i],o=e[a],u=n-i;return r[0]=P(U(s[0],o[0],u)),r[1]=P(U(s[1],o[1],u)),r[2]=P(U(s[2],o[2],u)),r[3]=C(U(s[3],o[3],u)),r}},w.fastMapToColor=w.fastLerp,w.lerp=function(t,e,r){if(e&&e.length&&t>=0&&t<=1){var n=t*(e.length-1),i=Math.floor(n),a=Math.ceil(n),s=w.parse(e[i]),o=w.parse(e[a]),u=n-i,f=w.stringify([P(U(s[0],o[0],u)),P(U(s[1],o[1],u)),P(U(s[2],o[2],u)),C(U(s[3],o[3],u))],"rgba");return r?{color:f,leftIndex:i,rightIndex:a,value:n}:f}},w.mapToColor=w.lerp,w.modifyHSL=function(t,e,r,n){if(t=w.parse(t))return t=function(t){if(t){var e,r,n=t[0]/255,i=t[1]/255,a=t[2]/255,s=Math.min(n,i,a),o=Math.max(n,i,a),u=o-s,f=(o+s)/2;if(0===u)e=0,r=0;else{r=f<.5?u/(o+s):u/(2-o-s);var h=((o-n)/6+u/2)/u,l=((o-i)/6+u/2)/u,c=((o-a)/6+u/2)/u;n===o?e=c-l:i===o?e=1/3+h-c:a===o&&(e=2/3+l-h),e<0&&(e+=1),e>1&&(e-=1)}var d=[360*e,r,f];return null!=t[3]&&d.push(t[3]),d}}(t),null!=e&&(t[0]=(i=e,(i=Math.round(i))<0?0:i>360?360:i)),null!=r&&(t[1]=k(r)),null!=n&&(t[2]=k(n)),w.stringify(q(t),"rgba");var i},w.modifyAlpha=function(t,e){if((t=w.parse(t))&&null!=e)return t[3]=C(e),w.stringify(t,"rgba")},w.stringify=function(t,e){if(t&&t.length){var r=t[0]+","+t[1]+","+t[2];return"rgba"!==e&&"hsva"!==e&&"hsla"!==e||(r+=","+t[3]),e+"("+r+")"}};var z=w.parseToFloat,J={};function G(t){var e=Object.keys(t);e.sort();for(var r=[],n=0;n<e.length;n++){var i=e[n],a=t[i];null===a?r.push(i):r.push(i+" "+a.toString())}return r.join("\n")}var X,K=c.extend(function(){return{name:"",depthTest:!0,depthMask:!0,transparent:!1,blend:null,autoUpdateTextureStatus:!0,uniforms:{},vertexDefines:{},fragmentDefines:{},_textureStatus:{},_enabledUniforms:null}},function(){this.name||(this.name="MATERIAL_"+this.__uid__),this.shader&&this.attachShader(this.shader,!0)},{precision:"highp",setUniform:function(t,e){void 0===e&&console.warn('Uniform value "'+t+'" is undefined');var r=this.uniforms[t];r&&("string"==typeof e&&(e=z(e)||e),r.value=e,this.autoUpdateTextureStatus&&"t"===r.type&&(e?this.enableTexture(t):this.disableTexture(t)))},setUniforms:function(t){for(var e in t){var r=t[e];this.setUniform(e,r)}},isUniformEnabled:function(t){return this._enabledUniforms.indexOf(t)>=0},getEnabledUniforms:function(){return this._enabledUniforms},getTextureUniforms:function(){return this._textureUniforms},set:function(t,e){if("object"==typeof t)for(var r in t){var n=t[r];this.setUniform(r,n)}else this.setUniform(t,e)},get:function(t){var e=this.uniforms[t];if(e)return e.value},attachShader:function(t,e){var r=this.uniforms;this.uniforms=t.createUniforms(),this.shader=t;var n=this.uniforms;this._enabledUniforms=Object.keys(n),this._enabledUniforms.sort(),this._textureUniforms=this._enabledUniforms.filter(function(t){var e=this.uniforms[t].type;return"t"===e||"tv"===e},this);var i=this.vertexDefines,a=this.fragmentDefines;if(this.vertexDefines=h.clone(t.vertexDefines),this.fragmentDefines=h.clone(t.fragmentDefines),e){for(var s in r)n[s]&&(n[s].value=r[s].value);h.defaults(this.vertexDefines,i),h.defaults(this.fragmentDefines,a)}var o={};for(var u in t.textures)o[u]={shaderType:t.textures[u].shaderType,type:t.textures[u].type,enabled:!(!e||!this._textureStatus[u])&&this._textureStatus[u].enabled};this._textureStatus=o,this._programKey=""},clone:function(){var t=new this.constructor({name:this.name,shader:this.shader});for(var e in this.uniforms)t.uniforms[e].value=this.uniforms[e].value;return t.depthTest=this.depthTest,t.depthMask=this.depthMask,t.transparent=this.transparent,t.blend=this.blend,t.vertexDefines=h.clone(this.vertexDefines),t.fragmentDefines=h.clone(this.fragmentDefines),t.enableTexture(this.getEnabledTextures()),t.precision=this.precision,t},define:function(t,e,r){var n=this.vertexDefines,i=this.fragmentDefines;"vertex"!==t&&"fragment"!==t&&"both"!==t&&arguments.length<3&&(r=e,e=t,t="both"),r=null!=r?r:null,"vertex"!==t&&"both"!==t||n[e]!==r&&(n[e]=r,this._programKey=""),"fragment"!==t&&"both"!==t||i[e]!==r&&(i[e]=r,"both"!==t&&(this._programKey=""))},undefine:function(t,e){"vertex"!==t&&"fragment"!==t&&"both"!==t&&arguments.length<2&&(e=t,t="both"),"vertex"!==t&&"both"!==t||this.isDefined("vertex",e)&&(delete this.vertexDefines[e],this._programKey=""),"fragment"!==t&&"both"!==t||this.isDefined("fragment",e)&&(delete this.fragmentDefines[e],"both"!==t&&(this._programKey=""))},isDefined:function(t,e){switch(t){case"vertex":return void 0!==this.vertexDefines[e];case"fragment":return void 0!==this.fragmentDefines[e]}},getDefine:function(t,e){switch(t){case"vertex":return this.vertexDefines[e];case"fragment":return this.fragmentDefines[e]}},enableTexture:function(t){if(Array.isArray(t))for(var e=0;e<t.length;e++)this.enableTexture(t[e]);else{var r=this._textureStatus[t];if(r)r.enabled||(r.enabled=!0,this._programKey="")}},enableTexturesAll:function(){var t=this._textureStatus;for(var e in t)t[e].enabled=!0;this._programKey=""},disableTexture:function(t){if(Array.isArray(t))for(var e=0;e<t.length;e++)this.disableTexture(t[e]);else{var r=this._textureStatus[t];if(r)!r.enabled||(r.enabled=!1,this._programKey="")}},disableTexturesAll:function(){var t=this._textureStatus;for(var e in t)t[e].enabled=!1;this._programKey=""},isTextureEnabled:function(t){var e=this._textureStatus;return!!e[t]&&e[t].enabled},getEnabledTextures:function(){var t=[],e=this._textureStatus;for(var r in e)e[r].enabled&&t.push(r);return t},dirtyDefines:function(){this._programKey=""},getProgramKey:function(){return this._programKey||(this._programKey=function(t,e,r){r.sort();for(var n=[],i=0;i<r.length;i++){var a=r[i];n.push(a)}var s=G(t)+"\n"+G(e)+"\n"+n.join("\n");if(J[s])return J[s];var o=h.genGUID();return J[s]=o,o}(this.vertexDefines,this.fragmentDefines,this.getEnabledTextures())),this._programKey}}),H=Array,Z=Math.random,Y={};Y.create=function(){var t=new H(2);return t[0]=0,t[1]=0,t},Y.clone=function(t){var e=new H(2);return e[0]=t[0],e[1]=t[1],e},Y.fromValues=function(t,e){var r=new H(2);return r[0]=t,r[1]=e,r},Y.copy=function(t,e){return t[0]=e[0],t[1]=e[1],t},Y.set=function(t,e,r){return t[0]=e,t[1]=r,t},Y.add=function(t,e,r){return t[0]=e[0]+r[0],t[1]=e[1]+r[1],t},Y.subtract=function(t,e,r){return t[0]=e[0]-r[0],t[1]=e[1]-r[1],t},Y.sub=Y.subtract,Y.multiply=function(t,e,r){return t[0]=e[0]*r[0],t[1]=e[1]*r[1],t},Y.mul=Y.multiply,Y.divide=function(t,e,r){return t[0]=e[0]/r[0],t[1]=e[1]/r[1],t},Y.div=Y.divide,Y.min=function(t,e,r){return t[0]=Math.min(e[0],r[0]),t[1]=Math.min(e[1],r[1]),t},Y.max=function(t,e,r){return t[0]=Math.max(e[0],r[0]),t[1]=Math.max(e[1],r[1]),t},Y.scale=function(t,e,r){return t[0]=e[0]*r,t[1]=e[1]*r,t},Y.scaleAndAdd=function(t,e,r,n){return t[0]=e[0]+r[0]*n,t[1]=e[1]+r[1]*n,t},Y.distance=function(t,e){var r=e[0]-t[0],n=e[1]-t[1];return Math.sqrt(r*r+n*n)},Y.dist=Y.distance,Y.squaredDistance=function(t,e){var r=e[0]-t[0],n=e[1]-t[1];return r*r+n*n},Y.sqrDist=Y.squaredDistance,Y.length=function(t){var e=t[0],r=t[1];return Math.sqrt(e*e+r*r)},Y.len=Y.length,Y.squaredLength=function(t){var e=t[0],r=t[1];return e*e+r*r},Y.sqrLen=Y.squaredLength,Y.negate=function(t,e){return t[0]=-e[0],t[1]=-e[1],t},Y.inverse=function(t,e){return t[0]=1/e[0],t[1]=1/e[1],t},Y.normalize=function(t,e){var r=e[0],n=e[1],i=r*r+n*n;return i>0&&(i=1/Math.sqrt(i),t[0]=e[0]*i,t[1]=e[1]*i),t},Y.dot=function(t,e){return t[0]*e[0]+t[1]*e[1]},Y.cross=function(t,e,r){var n=e[0]*r[1]-e[1]*r[0];return t[0]=t[1]=0,t[2]=n,t},Y.lerp=function(t,e,r,n){var i=e[0],a=e[1];return t[0]=i+n*(r[0]-i),t[1]=a+n*(r[1]-a),t},Y.random=function(t,e){e=e||1;var r=2*GLMAT_RANDOM()*Math.PI;return t[0]=Math.cos(r)*e,t[1]=Math.sin(r)*e,t},Y.transformMat2=function(t,e,r){var n=e[0],i=e[1];return t[0]=r[0]*n+r[2]*i,t[1]=r[1]*n+r[3]*i,t},Y.transformMat2d=function(t,e,r){var n=e[0],i=e[1];return t[0]=r[0]*n+r[2]*i+r[4],t[1]=r[1]*n+r[3]*i+r[5],t},Y.transformMat3=function(t,e,r){var n=e[0],i=e[1];return t[0]=r[0]*n+r[3]*i+r[6],t[1]=r[1]*n+r[4]*i+r[7],t},Y.transformMat4=function(t,e,r){var n=e[0],i=e[1];return t[0]=r[0]*n+r[4]*i+r[12],t[1]=r[1]*n+r[5]*i+r[13],t},Y.forEach=(X=Y.create(),function(t,e,r,n,i,a){var s,o;for(e||(e=2),r||(r=0),o=n?Math.min(n*e+r,t.length):t.length,s=r;s<o;s+=e)X[0]=t[s],X[1]=t[s+1],i(X,X,a),t[s]=X[0],t[s+1]=X[1];return t});var Q=Y,$=function(t,e){t=t||0,e=e||0,this.array=Q.fromValues(t,e),this._dirty=!0};if($.prototype={constructor:$,add:function(t){return Q.add(this.array,this.array,t.array),this._dirty=!0,this},set:function(t,e){return this.array[0]=t,this.array[1]=e,this._dirty=!0,this},setArray:function(t){return this.array[0]=t[0],this.array[1]=t[1],this._dirty=!0,this},clone:function(){return new $(this.x,this.y)},copy:function(t){return Q.copy(this.array,t.array),this._dirty=!0,this},cross:function(t,e){return Q.cross(t.array,this.array,e.array),t._dirty=!0,this},dist:function(t){return Q.dist(this.array,t.array)},distance:function(t){return Q.distance(this.array,t.array)},div:function(t){return Q.div(this.array,this.array,t.array),this._dirty=!0,this},divide:function(t){return Q.divide(this.array,this.array,t.array),this._dirty=!0,this},dot:function(t){return Q.dot(this.array,t.array)},len:function(){return Q.len(this.array)},length:function(){return Q.length(this.array)},lerp:function(t,e,r){return Q.lerp(this.array,t.array,e.array,r),this._dirty=!0,this},min:function(t){return Q.min(this.array,this.array,t.array),this._dirty=!0,this},max:function(t){return Q.max(this.array,this.array,t.array),this._dirty=!0,this},mul:function(t){return Q.mul(this.array,this.array,t.array),this._dirty=!0,this},multiply:function(t){return Q.multiply(this.array,this.array,t.array),this._dirty=!0,this},negate:function(){return Q.negate(this.array,this.array),this._dirty=!0,this},normalize:function(){return Q.normalize(this.array,this.array),this._dirty=!0,this},random:function(t){return Q.random(this.array,t),this._dirty=!0,this},scale:function(t){return Q.scale(this.array,this.array,t),this._dirty=!0,this},scaleAndAdd:function(t,e){return Q.scaleAndAdd(this.array,this.array,t.array,e),this._dirty=!0,this},sqrDist:function(t){return Q.sqrDist(this.array,t.array)},squaredDistance:function(t){return Q.squaredDistance(this.array,t.array)},sqrLen:function(){return Q.sqrLen(this.array)},squaredLength:function(){return Q.squaredLength(this.array)},sub:function(t){return Q.sub(this.array,this.array,t.array),this._dirty=!0,this},subtract:function(t){return Q.subtract(this.array,this.array,t.array),this._dirty=!0,this},transformMat2:function(t){return Q.transformMat2(this.array,this.array,t.array),this._dirty=!0,this},transformMat2d:function(t){return Q.transformMat2d(this.array,this.array,t.array),this._dirty=!0,this},transformMat3:function(t){return Q.transformMat3(this.array,this.array,t.array),this._dirty=!0,this},transformMat4:function(t){return Q.transformMat4(this.array,this.array,t.array),this._dirty=!0,this},toString:function(){return"["+Array.prototype.join.call(this.array,",")+"]"},toArray:function(){return Array.prototype.slice.call(this.array)}},Object.defineProperty){var tt=$.prototype;Object.defineProperty(tt,"x",{get:function(){return this.array[0]},set:function(t){this.array[0]=t,this._dirty=!0}}),Object.defineProperty(tt,"y",{get:function(){return this.array[1]},set:function(t){this.array[1]=t,this._dirty=!0}})}$.add=function(t,e,r){return Q.add(t.array,e.array,r.array),t._dirty=!0,t},$.set=function(t,e,r){return Q.set(t.array,e,r),t._dirty=!0,t},$.copy=function(t,e){return Q.copy(t.array,e.array),t._dirty=!0,t},$.cross=function(t,e,r){return Q.cross(t.array,e.array,r.array),t._dirty=!0,t},$.distance=$.dist=function(t,e){return Q.distance(t.array,e.array)},$.divide=$.div=function(t,e,r){return Q.divide(t.array,e.array,r.array),t._dirty=!0,t},$.dot=function(t,e){return Q.dot(t.array,e.array)},$.len=function(t){return Q.length(t.array)},$.lerp=function(t,e,r,n){return Q.lerp(t.array,e.array,r.array,n),t._dirty=!0,t},$.min=function(t,e,r){return Q.min(t.array,e.array,r.array),t._dirty=!0,t},$.max=function(t,e,r){return Q.max(t.array,e.array,r.array),t._dirty=!0,t},$.multiply=$.mul=function(t,e,r){return Q.multiply(t.array,e.array,r.array),t._dirty=!0,t},$.negate=function(t,e){return Q.negate(t.array,e.array),t._dirty=!0,t},$.normalize=function(t,e){return Q.normalize(t.array,e.array),t._dirty=!0,t},$.random=function(t,e){return Q.random(t.array,e),t._dirty=!0,t},$.scale=function(t,e,r){return Q.scale(t.array,e.array,r),t._dirty=!0,t},$.scaleAndAdd=function(t,e,r,n){return Q.scaleAndAdd(t.array,e.array,r.array,n),t._dirty=!0,t},$.squaredDistance=$.sqrDist=function(t,e){return Q.sqrDist(t.array,e.array)},$.squaredLength=$.sqrLen=function(t){return Q.sqrLen(t.array)},$.subtract=$.sub=function(t,e,r){return Q.subtract(t.array,e.array,r.array),t._dirty=!0,t},$.transformMat2=function(t,e,r){return Q.transformMat2(t.array,e.array,r.array),t._dirty=!0,t},$.transformMat2d=function(t,e,r){return Q.transformMat2d(t.array,e.array,r.array),t._dirty=!0,t},$.transformMat3=function(t,e,r){return Q.transformMat3(t.array,e.array,r.array),t._dirty=!0,t},$.transformMat4=function(t,e,r){return Q.transformMat4(t.array,e.array,r.array),t._dirty=!0,t};var et=$,rt=!0;try{var nt=document.createElement("canvas");if(!(nt.getContext("webgl")||nt.getContext("experimental-webgl")))throw new Error}catch(t){rt=!1}var it={supportWebGL:function(){return rt}};it.Int8Array="undefined"==typeof Int8Array?Array:Int8Array,it.Uint8Array="undefined"==typeof Uint8Array?Array:Uint8Array,it.Uint16Array="undefined"==typeof Uint16Array?Array:Uint16Array,it.Uint32Array="undefined"==typeof Uint32Array?Array:Uint32Array,it.Int16Array="undefined"==typeof Int16Array?Array:Int16Array,it.Float32Array="undefined"==typeof Float32Array?Array:Float32Array,it.Float64Array="undefined"==typeof Float64Array?Array:Float64Array;var at=it,st={};function ot(t,e,r){if(!t.getShaderParameter(e,t.COMPILE_STATUS))return[t.getShaderInfoLog(e),function(t){for(var e=t.split("\n"),r=0,n=e.length;r<n;r++)e[r]=r+1+": "+e[r];return e.join("\n")}(r)].join("\n")}var ut=new at.Float32Array(16),ft=c.extend({uniformSemantics:{},attributes:{}},function(){this._locations={},this._textureSlot=0,this._program=null},{bind:function(t){this._textureSlot=0,t.gl.useProgram(this._program)},hasUniform:function(t){var e=this._locations[t];return null!==e&&void 0!==e},useTextureSlot:function(t,e,r){e&&(t.gl.activeTexture(t.gl.TEXTURE0+r),e.isRenderable()?e.bind(t):e.unbind(t))},currentTextureSlot:function(){return this._textureSlot},resetTextureSlot:function(t){this._textureSlot=t||0},takeCurrentTextureSlot:function(t,e){var r=this._textureSlot;return this.useTextureSlot(t,e,r),this._textureSlot++,r},setUniform:function(t,e,r,n){var i=this._locations[r];if(null===i||void 0===i)return!1;switch(e){case"m4":if(!(n instanceof Float32Array)){for(var a=0;a<n.length;a++)ut[a]=n[a];n=ut}t.uniformMatrix4fv(i,!1,n);break;case"2i":t.uniform2i(i,n[0],n[1]);break;case"2f":t.uniform2f(i,n[0],n[1]);break;case"3i":t.uniform3i(i,n[0],n[1],n[2]);break;case"3f":t.uniform3f(i,n[0],n[1],n[2]);break;case"4i":t.uniform4i(i,n[0],n[1],n[2],n[3]);break;case"4f":t.uniform4f(i,n[0],n[1],n[2],n[3]);break;case"1i":t.uniform1i(i,n);break;case"1f":t.uniform1f(i,n);break;case"1fv":t.uniform1fv(i,n);break;case"1iv":t.uniform1iv(i,n);break;case"2iv":t.uniform2iv(i,n);break;case"2fv":t.uniform2fv(i,n);break;case"3iv":t.uniform3iv(i,n);break;case"3fv":t.uniform3fv(i,n);break;case"4iv":t.uniform4iv(i,n);break;case"4fv":t.uniform4fv(i,n);break;case"m2":case"m2v":t.uniformMatrix2fv(i,!1,n);break;case"m3":case"m3v":t.uniformMatrix3fv(i,!1,n);break;case"m4v":if(Array.isArray(n)&&Array.isArray(n[0])){var s=new at.Float32Array(16*n.length),o=0;for(a=0;a<n.length;a++)for(var u=n[a],f=0;f<16;f++)s[o++]=u[f];t.uniformMatrix4fv(i,!1,s)}else t.uniformMatrix4fv(i,!1,n)}return!0},setUniformOfSemantic:function(t,e,r){var n=this.uniformSemantics[e];return!!n&&this.setUniform(t,n.type,n.symbol,r)},enableAttributes:function(t,e,r){var n,i=t.gl,a=this._program,s=this._locations;(n=r?r.__enabledAttributeList:st[t.__uid__])||(n=r?r.__enabledAttributeList=[]:st[t.__uid__]=[]);for(var o=[],u=0;u<e.length;u++){var f=e[u];if(this.attributes[f]){var h=s[f];if(null==h){if(-1===(h=i.getAttribLocation(a,f))){o[u]=-1;continue}s[f]=h}o[u]=h,n[h]?n[h]=2:n[h]=1}else o[u]=-1}for(u=0;u<n.length;u++)switch(n[u]){case 1:i.enableVertexAttribArray(u),n[u]=3;break;case 2:n[u]=3;break;case 3:i.disableVertexAttribArray(u),n[u]=0}return o},buildProgram:function(t,e,r,n){var i=t.createShader(t.VERTEX_SHADER),a=t.createProgram();t.shaderSource(i,r),t.compileShader(i);var s=t.createShader(t.FRAGMENT_SHADER);t.shaderSource(s,n),t.compileShader(s);var o=ot(t,i,r);if(o)return o;if(o=ot(t,s,n))return o;if(t.attachShader(a,i),t.attachShader(a,s),e.attributeSemantics.POSITION)t.bindAttribLocation(a,0,e.attributeSemantics.POSITION.symbol);else{var u=Object.keys(this.attributes);t.bindAttribLocation(a,0,u[0])}if(t.linkProgram(a),!t.getProgramParameter(a,t.LINK_STATUS))return"Could not link program\nVALIDATE_STATUS: "+t.getProgramParameter(a,t.VALIDATE_STATUS)+", gl error ["+t.getError()+"]";for(var f=0;f<e.uniforms.length;f++){var h=e.uniforms[f];this._locations[h]=t.getUniformLocation(a,h)}t.deleteShader(i),t.deleteShader(s),this._program=a,this.vertexCode=r,this.fragmentCode=n}}),ht=/for\s*?\(int\s*?_idx_\s*\=\s*([\w-]+)\;\s*_idx_\s*<\s*([\w-]+);\s*_idx_\s*\+\+\s*\)\s*\{\{([\s\S]+?)(?=\}\})\}\}/g;function lt(t,e,r){var n={};for(var i in r)n[i+"_COUNT"]=r[i];return t.replace(ht,function(t,r,i,a){var s="";isNaN(r)&&(r=r in e?e[r]:n[r]),isNaN(i)&&(i=i in e?e[i]:n[i]);for(var o=parseInt(r);o<parseInt(i);o++)s+="{"+a.replace(/float\s*\(\s*_idx_\s*\)/g,o.toFixed(1)).replace(/_idx_/g,o)+"}";return s})}function ct(t,e,r){var n=[];if(e)for(var i in e){var a=e[i];a>0&&n.push("#define "+i.toUpperCase()+"_COUNT "+a)}if(r)for(var s=0;s<r.length;s++){var o=r[s];n.push("#define "+o.toUpperCase()+"_ENABLED")}for(var o in t){var u=t[o];null===u?n.push("#define "+o):n.push("#define "+o+" "+u.toString())}return n.join("\n")}function dt(t){this._renderer=t,this._cache={}}dt.prototype.getProgram=function(t,e,r){var n=this._cache,i=t.isSkinnedMesh&&t.isSkinnedMesh(),a="s"+e.shader.shaderID+"m"+e.getProgramKey();if(r&&(a+="se"+r.getProgramKey(t.lightGroup)),i&&(a+=","+t.joints.length),m=n[a])return m;var s=r?r.getLightsNumbers(t.lightGroup):{},o=this._renderer,u=o.gl,f=e.getEnabledTextures(),h="";if(i){var l={SKINNING:null,JOINT_COUNT:t.joints.length};t.joints.length>o.getMaxJointNumber()&&(l.USE_SKIN_MATRICES_TEXTURE=null),h="\n"+ct(l)+"\n"}var c=h+ct(e.vertexDefines,s,f),d=h+ct(e.fragmentDefines,s,f),_=c+"\n"+e.shader.vertex,v=["OES_standard_derivatives","EXT_shader_texture_lod"].filter(function(t){return null!=o.getGLExtension(t)});v.indexOf("EXT_shader_texture_lod")>=0&&(d+="\n#define SUPPORT_TEXTURE_LOD");var p,m,y=function(t){for(var e=[],r=0;r<t.length;r++)e.push("#extension GL_"+t[r]+" : enable");return e.join("\n")}(v)+"\n"+(["precision",p=e.precision,"float"].join(" ")+";\n"+["precision",p,"int"].join(" ")+";\n"+["precision",p,"sampler2D"].join(" ")+";\n")+"\n"+d+"\n"+e.shader.fragment,g=lt(_,e.vertexDefines,s),b=lt(y,e.fragmentDefines,s);(m=new ft).uniformSemantics=e.shader.uniformSemantics,m.attributes=e.shader.attributes;var E=m.buildProgram(u,e.shader,g,b);return m.__error=E,n[a]=m,m};var _t=dt,vt=/uniform\s+(bool|float|int|vec2|vec3|vec4|ivec2|ivec3|ivec4|mat2|mat3|mat4|sampler2D|samplerCube)\s+([\s\S]*?);/g,pt=/attribute\s+(float|int|vec2|vec3|vec4)\s+([\s\S]*?);/g,mt=/#define\s+(\w+)?(\s+[\w-.]+)?\s*;?\s*\n/g,yt={bool:"1i",int:"1i",sampler2D:"t",samplerCube:"t",float:"1f",vec2:"2f",vec3:"3f",vec4:"4f",ivec2:"2i",ivec3:"3i",ivec4:"4i",mat2:"m2",mat3:"m3",mat4:"m4"};function gt(t){for(var e=[],r=0;r<t;r++)e[r]=0;return e}var bt={bool:function(){return!0},int:function(){return 0},float:function(){return 0},sampler2D:function(){return null},samplerCube:function(){return null},vec2:function(){return gt(2)},vec3:function(){return gt(3)},vec4:function(){return gt(4)},ivec2:function(){return gt(2)},ivec3:function(){return gt(3)},ivec4:function(){return gt(4)},mat2:function(){return gt(4)},mat3:function(){return gt(9)},mat4:function(){return gt(16)},array:function(){return[]}},Et=["POSITION","NORMAL","BINORMAL","TANGENT","TEXCOORD","TEXCOORD_0","TEXCOORD_1","COLOR","JOINT","WEIGHT"],xt=["SKIN_MATRIX","VIEWPORT_SIZE","VIEWPORT","DEVICEPIXELRATIO","WINDOW_SIZE","NEAR","FAR","TIME"],St=["WORLD","VIEW","PROJECTION","WORLDVIEW","VIEWPROJECTION","WORLDVIEWPROJECTION","WORLDINVERSE","VIEWINVERSE","PROJECTIONINVERSE","WORLDVIEWINVERSE","VIEWPROJECTIONINVERSE","WORLDVIEWPROJECTIONINVERSE","WORLDTRANSPOSE","VIEWTRANSPOSE","PROJECTIONTRANSPOSE","WORLDVIEWTRANSPOSE","VIEWPROJECTIONTRANSPOSE","WORLDVIEWPROJECTIONTRANSPOSE","WORLDINVERSETRANSPOSE","VIEWINVERSETRANSPOSE","PROJECTIONINVERSETRANSPOSE","WORLDVIEWINVERSETRANSPOSE","VIEWPROJECTIONINVERSETRANSPOSE","WORLDVIEWPROJECTIONINVERSETRANSPOSE"],Ot={vec4:4,vec3:3,vec2:2,float:1},Rt={},At={};function It(t){return t.replace(/[ \t]*\/\/.*\n/g,"").replace(/[ \t]*\/\*[\s\S]*?\*\//g,"")}function Tt(){console.error("Wrong uniform/attributes syntax")}function Mt(t,e){for(var r=/[,=\(\):]/,n=e.replace(/:\s*\[\s*(.*)\s*\]/g,"="+t+"($1)").replace(/\s+/g,"").split(/(?=[,=\(\):])/g),i=[],a=0;a<n.length;a++)n[a].match(r)?i.push(n[a].charAt(0),n[a].slice(1)):i.push(n[a]);var s,o=0,u={},f=null;function h(t){t||Tt();var e=t.match(/\[(.*?)\]/);s=t.replace(/\[(.*?)\]/,""),u[s]={},e&&(u[s].isArray=!0,u[s].arraySize=e[1])}h((n=i)[0]);for(a=1;a<n.length;a++){var l=n[a];if(l)if("="!==l)if(":"!==l)if(","!==l)if(")"!==l)if("("!==l)if(l.indexOf("vec")>=0){if(1!==o&&4!==o){Tt();break}o=2,f=[]}else if(1!==o)if(4!==o)h(l),o=0;else{var c=l;Et.indexOf(c)>=0||xt.indexOf(c)>=0||St.indexOf(c)>=0?u[s].semantic=c:"ignore"===c||"unconfigurable"===c?u[s].ignore=!0:u[s].value="bool"===t?"true"===c:parseFloat(c)}else u[s].value="bool"===t?"true"===l:parseFloat(l),f=null;else{if(2!==o){Tt();break}if(!(f instanceof Array)){Tt();break}f.push(+n[++a])}else u[s].value=new at.Float32Array(f),f=null,o=5;else if(2===o){if(!(f instanceof Array)){Tt();break}f.push(+n[++a])}else o=5;else o=4;else{if(0!==o&&3!==o){Tt();break}o=1}}return u}function wt(t,e){"object"==typeof t&&(e=t.fragment,t=t.vertex),t=It(t),e=It(e),this._shaderID=function(t,e){var r="vertex:"+t+"fragment:"+e;if(Rt[r])return Rt[r];var n=h.genGUID();return Rt[r]=n,At[n]={vertex:t,fragment:e},n}(t,e),this._vertexCode=wt.parseImport(t),this._fragmentCode=wt.parseImport(e),this.attributeSemantics={},this.matrixSemantics={},this.uniformSemantics={},this.matrixSemanticKeys=[],this.uniformTemplates={},this.attributes={},this.textures={},this.vertexDefines={},this.fragmentDefines={},this._parseAttributes(),this._parseUniforms(),this._parseDefines()}wt.prototype={constructor:wt,createUniforms:function(){var t={};for(var e in this.uniformTemplates){var r=this.uniformTemplates[e];t[e]={type:r.type,value:r.value()}}return t},_parseImport:function(){this._vertexCode=wt.parseImport(this.vertex),this._fragmentCode=wt.parseImport(this.fragment)},_addSemanticUniform:function(t,e,r){if(Et.indexOf(r)>=0)this.attributeSemantics[r]={symbol:t,type:e};else if(St.indexOf(r)>=0){var n=!1,i=r;r.match(/TRANSPOSE$/)&&(n=!0,i=r.slice(0,-9)),this.matrixSemantics[r]={symbol:t,type:e,isTranspose:n,semanticNoTranspose:i}}else xt.indexOf(r)>=0&&(this.uniformSemantics[r]={symbol:t,type:e})},_addMaterialUniform:function(t,e,r,n,i,a){a[t]={type:r,value:i?bt.array:n||bt[e],semantic:null}},_parseUniforms:function(){var t={},e=this,r="vertex";function n(t){return null!=t?function(){return t}:null}function i(i,a,s){var o=Mt(a,s),u=[];for(var f in o){var h=o[f],l=h.semantic,c=f,d=yt[a],_=n(o[f].value);o[f].isArray&&(c+="["+o[f].arraySize+"]",d+="v"),u.push(c),e._uniformList.push(f),h.ignore||("sampler2D"!==a&&"samplerCube"!==a||(e.textures[f]={shaderType:r,type:a}),l?e._addSemanticUniform(f,d,l):e._addMaterialUniform(f,a,d,_,o[f].isArray,t))}return u.length>0?"uniform "+a+" "+u.join(",")+";\n":""}this._uniformList=[],this._vertexCode=this._vertexCode.replace(vt,i),r="fragment",this._fragmentCode=this._fragmentCode.replace(vt,i),e.matrixSemanticKeys=Object.keys(this.matrixSemantics),this.uniformTemplates=t},_parseAttributes:function(){var t={},e=this;this._vertexCode=this._vertexCode.replace(pt,function(r,n,i){var a=Mt(n,i),s=Ot[n]||1,o=[];for(var u in a){var f=a[u].semantic;if(t[u]={type:"float",size:s,semantic:f||null},f){if(Et.indexOf(f)<0)throw new Error('Unkown semantic "'+f+'"');e.attributeSemantics[f]={symbol:u,type:n}}o.push(u)}return"attribute "+n+" "+o.join(",")+";\n"}),this.attributes=t},_parseDefines:function(){var t=this,e="vertex";function r(r,n,i){var a="vertex"===e?t.vertexDefines:t.fragmentDefines;return a[n]||(a[n]="false"!==i&&("true"===i||(i?isNaN(parseFloat(i))?i.trim():parseFloat(i):null))),""}this._vertexCode=this._vertexCode.replace(mt,r),e="fragment",this._fragmentCode=this._fragmentCode.replace(mt,r)},clone:function(){var t=At[this._shaderID];return new wt(t.vertex,t.fragment)}},Object.defineProperty&&(Object.defineProperty(wt.prototype,"shaderID",{get:function(){return this._shaderID}}),Object.defineProperty(wt.prototype,"vertex",{get:function(){return this._vertexCode}}),Object.defineProperty(wt.prototype,"fragment",{get:function(){return this._fragmentCode}}),Object.defineProperty(wt.prototype,"uniforms",{get:function(){return this._uniformList}}));var Nt=/(@import)\s*([0-9a-zA-Z_\-\.]*)/g;wt.parseImport=function(t){return t=t.replace(Nt,function(t,e,r){return(t=wt.source(r))?wt.parseImport(t):(console.error('Shader chunk "'+r+'" not existed in library'),"")})};var Pt=/(@export)\s*([0-9a-zA-Z_\-\.]*)\s*\n([\s\S]*?)@end/g;wt.import=function(t){t.replace(Pt,function(t,e,r,n){if(n=n.replace(/(^[\s\t\xa0\u3000]+)|([\u3000\xa0\s\t]+\x24)/g,"")){for(var i,a=r.split("."),s=wt.codes,o=0;o<a.length-1;)s[i=a[o++]]||(s[i]={}),s=s[i];s[i=a[o]]=n}return n})},wt.codes={},wt.source=function(t){for(var e=t.split("."),r=wt.codes,n=0;r&&n<e.length;){r=r[e[n++]]}return"string"!=typeof r?(console.error('Shader "'+t+'" not existed in library'),""):r};var Ct=wt,Dt={create:function(){var t=new H(16);return t[0]=1,t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=1,t[6]=0,t[7]=0,t[8]=0,t[9]=0,t[10]=1,t[11]=0,t[12]=0,t[13]=0,t[14]=0,t[15]=1,t},clone:function(t){var e=new H(16);return e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e[4]=t[4],e[5]=t[5],e[6]=t[6],e[7]=t[7],e[8]=t[8],e[9]=t[9],e[10]=t[10],e[11]=t[11],e[12]=t[12],e[13]=t[13],e[14]=t[14],e[15]=t[15],e},copy:function(t,e){return t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],t[4]=e[4],t[5]=e[5],t[6]=e[6],t[7]=e[7],t[8]=e[8],t[9]=e[9],t[10]=e[10],t[11]=e[11],t[12]=e[12],t[13]=e[13],t[14]=e[14],t[15]=e[15],t},identity:function(t){return t[0]=1,t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=1,t[6]=0,t[7]=0,t[8]=0,t[9]=0,t[10]=1,t[11]=0,t[12]=0,t[13]=0,t[14]=0,t[15]=1,t},transpose:function(t,e){if(t===e){var r=e[1],n=e[2],i=e[3],a=e[6],s=e[7],o=e[11];t[1]=e[4],t[2]=e[8],t[3]=e[12],t[4]=r,t[6]=e[9],t[7]=e[13],t[8]=n,t[9]=a,t[11]=e[14],t[12]=i,t[13]=s,t[14]=o}else t[0]=e[0],t[1]=e[4],t[2]=e[8],t[3]=e[12],t[4]=e[1],t[5]=e[5],t[6]=e[9],t[7]=e[13],t[8]=e[2],t[9]=e[6],t[10]=e[10],t[11]=e[14],t[12]=e[3],t[13]=e[7],t[14]=e[11],t[15]=e[15];return t},invert:function(t,e){var r=e[0],n=e[1],i=e[2],a=e[3],s=e[4],o=e[5],u=e[6],f=e[7],h=e[8],l=e[9],c=e[10],d=e[11],_=e[12],v=e[13],p=e[14],m=e[15],y=r*o-n*s,g=r*u-i*s,b=r*f-a*s,E=n*u-i*o,x=n*f-a*o,S=i*f-a*u,O=h*v-l*_,R=h*p-c*_,A=h*m-d*_,I=l*p-c*v,T=l*m-d*v,M=c*m-d*p,w=y*M-g*T+b*I+E*A-x*R+S*O;return w?(w=1/w,t[0]=(o*M-u*T+f*I)*w,t[1]=(i*T-n*M-a*I)*w,t[2]=(v*S-p*x+m*E)*w,t[3]=(c*x-l*S-d*E)*w,t[4]=(u*A-s*M-f*R)*w,t[5]=(r*M-i*A+a*R)*w,t[6]=(p*b-_*S-m*g)*w,t[7]=(h*S-c*b+d*g)*w,t[8]=(s*T-o*A+f*O)*w,t[9]=(n*A-r*T-a*O)*w,t[10]=(_*x-v*b+m*y)*w,t[11]=(l*b-h*x-d*y)*w,t[12]=(o*R-s*I-u*O)*w,t[13]=(r*I-n*R+i*O)*w,t[14]=(v*g-_*E-p*y)*w,t[15]=(h*E-l*g+c*y)*w,t):null},adjoint:function(t,e){var r=e[0],n=e[1],i=e[2],a=e[3],s=e[4],o=e[5],u=e[6],f=e[7],h=e[8],l=e[9],c=e[10],d=e[11],_=e[12],v=e[13],p=e[14],m=e[15];return t[0]=o*(c*m-d*p)-l*(u*m-f*p)+v*(u*d-f*c),t[1]=-(n*(c*m-d*p)-l*(i*m-a*p)+v*(i*d-a*c)),t[2]=n*(u*m-f*p)-o*(i*m-a*p)+v*(i*f-a*u),t[3]=-(n*(u*d-f*c)-o*(i*d-a*c)+l*(i*f-a*u)),t[4]=-(s*(c*m-d*p)-h*(u*m-f*p)+_*(u*d-f*c)),t[5]=r*(c*m-d*p)-h*(i*m-a*p)+_*(i*d-a*c),t[6]=-(r*(u*m-f*p)-s*(i*m-a*p)+_*(i*f-a*u)),t[7]=r*(u*d-f*c)-s*(i*d-a*c)+h*(i*f-a*u),t[8]=s*(l*m-d*v)-h*(o*m-f*v)+_*(o*d-f*l),t[9]=-(r*(l*m-d*v)-h*(n*m-a*v)+_*(n*d-a*l)),t[10]=r*(o*m-f*v)-s*(n*m-a*v)+_*(n*f-a*o),t[11]=-(r*(o*d-f*l)-s*(n*d-a*l)+h*(n*f-a*o)),t[12]=-(s*(l*p-c*v)-h*(o*p-u*v)+_*(o*c-u*l)),t[13]=r*(l*p-c*v)-h*(n*p-i*v)+_*(n*c-i*l),t[14]=-(r*(o*p-u*v)-s*(n*p-i*v)+_*(n*u-i*o)),t[15]=r*(o*c-u*l)-s*(n*c-i*l)+h*(n*u-i*o),t},determinant:function(t){var e=t[0],r=t[1],n=t[2],i=t[3],a=t[4],s=t[5],o=t[6],u=t[7],f=t[8],h=t[9],l=t[10],c=t[11],d=t[12],_=t[13],v=t[14],p=t[15];return(e*s-r*a)*(l*p-c*v)-(e*o-n*a)*(h*p-c*_)+(e*u-i*a)*(h*v-l*_)+(r*o-n*s)*(f*p-c*d)-(r*u-i*s)*(f*v-l*d)+(n*u-i*o)*(f*_-h*d)},multiply:function(t,e,r){var n=e[0],i=e[1],a=e[2],s=e[3],o=e[4],u=e[5],f=e[6],h=e[7],l=e[8],c=e[9],d=e[10],_=e[11],v=e[12],p=e[13],m=e[14],y=e[15],g=r[0],b=r[1],E=r[2],x=r[3];return t[0]=g*n+b*o+E*l+x*v,t[1]=g*i+b*u+E*c+x*p,t[2]=g*a+b*f+E*d+x*m,t[3]=g*s+b*h+E*_+x*y,g=r[4],b=r[5],E=r[6],x=r[7],t[4]=g*n+b*o+E*l+x*v,t[5]=g*i+b*u+E*c+x*p,t[6]=g*a+b*f+E*d+x*m,t[7]=g*s+b*h+E*_+x*y,g=r[8],b=r[9],E=r[10],x=r[11],t[8]=g*n+b*o+E*l+x*v,t[9]=g*i+b*u+E*c+x*p,t[10]=g*a+b*f+E*d+x*m,t[11]=g*s+b*h+E*_+x*y,g=r[12],b=r[13],E=r[14],x=r[15],t[12]=g*n+b*o+E*l+x*v,t[13]=g*i+b*u+E*c+x*p,t[14]=g*a+b*f+E*d+x*m,t[15]=g*s+b*h+E*_+x*y,t},multiplyAffine:function(t,e,r){var n=e[0],i=e[1],a=e[2],s=e[4],o=e[5],u=e[6],f=e[8],h=e[9],l=e[10],c=e[12],d=e[13],_=e[14],v=r[0],p=r[1],m=r[2];return t[0]=v*n+p*s+m*f,t[1]=v*i+p*o+m*h,t[2]=v*a+p*u+m*l,v=r[4],p=r[5],m=r[6],t[4]=v*n+p*s+m*f,t[5]=v*i+p*o+m*h,t[6]=v*a+p*u+m*l,v=r[8],p=r[9],m=r[10],t[8]=v*n+p*s+m*f,t[9]=v*i+p*o+m*h,t[10]=v*a+p*u+m*l,v=r[12],p=r[13],m=r[14],t[12]=v*n+p*s+m*f+c,t[13]=v*i+p*o+m*h+d,t[14]=v*a+p*u+m*l+_,t}};Dt.mul=Dt.multiply,Dt.mulAffine=Dt.multiplyAffine,Dt.translate=function(t,e,r){var n,i,a,s,o,u,f,h,l,c,d,_,v=r[0],p=r[1],m=r[2];return e===t?(t[12]=e[0]*v+e[4]*p+e[8]*m+e[12],t[13]=e[1]*v+e[5]*p+e[9]*m+e[13],t[14]=e[2]*v+e[6]*p+e[10]*m+e[14],t[15]=e[3]*v+e[7]*p+e[11]*m+e[15]):(n=e[0],i=e[1],a=e[2],s=e[3],o=e[4],u=e[5],f=e[6],h=e[7],l=e[8],c=e[9],d=e[10],_=e[11],t[0]=n,t[1]=i,t[2]=a,t[3]=s,t[4]=o,t[5]=u,t[6]=f,t[7]=h,t[8]=l,t[9]=c,t[10]=d,t[11]=_,t[12]=n*v+o*p+l*m+e[12],t[13]=i*v+u*p+c*m+e[13],t[14]=a*v+f*p+d*m+e[14],t[15]=s*v+h*p+_*m+e[15]),t},Dt.scale=function(t,e,r){var n=r[0],i=r[1],a=r[2];return t[0]=e[0]*n,t[1]=e[1]*n,t[2]=e[2]*n,t[3]=e[3]*n,t[4]=e[4]*i,t[5]=e[5]*i,t[6]=e[6]*i,t[7]=e[7]*i,t[8]=e[8]*a,t[9]=e[9]*a,t[10]=e[10]*a,t[11]=e[11]*a,t[12]=e[12],t[13]=e[13],t[14]=e[14],t[15]=e[15],t},Dt.rotate=function(t,e,r,n){var i,a,s,o,u,f,h,l,c,d,_,v,p,m,y,g,b,E,x,S,O,R,A,I,T=n[0],M=n[1],w=n[2],N=Math.sqrt(T*T+M*M+w*w);return Math.abs(N)<1e-6?null:(T*=N=1/N,M*=N,w*=N,i=Math.sin(r),s=1-(a=Math.cos(r)),o=e[0],u=e[1],f=e[2],h=e[3],l=e[4],c=e[5],d=e[6],_=e[7],v=e[8],p=e[9],m=e[10],y=e[11],g=T*T*s+a,b=M*T*s+w*i,E=w*T*s-M*i,x=T*M*s-w*i,S=M*M*s+a,O=w*M*s+T*i,R=T*w*s+M*i,A=M*w*s-T*i,I=w*w*s+a,t[0]=o*g+l*b+v*E,t[1]=u*g+c*b+p*E,t[2]=f*g+d*b+m*E,t[3]=h*g+_*b+y*E,t[4]=o*x+l*S+v*O,t[5]=u*x+c*S+p*O,t[6]=f*x+d*S+m*O,t[7]=h*x+_*S+y*O,t[8]=o*R+l*A+v*I,t[9]=u*R+c*A+p*I,t[10]=f*R+d*A+m*I,t[11]=h*R+_*A+y*I,e!==t&&(t[12]=e[12],t[13]=e[13],t[14]=e[14],t[15]=e[15]),t)},Dt.rotateX=function(t,e,r){var n=Math.sin(r),i=Math.cos(r),a=e[4],s=e[5],o=e[6],u=e[7],f=e[8],h=e[9],l=e[10],c=e[11];return e!==t&&(t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],t[12]=e[12],t[13]=e[13],t[14]=e[14],t[15]=e[15]),t[4]=a*i+f*n,t[5]=s*i+h*n,t[6]=o*i+l*n,t[7]=u*i+c*n,t[8]=f*i-a*n,t[9]=h*i-s*n,t[10]=l*i-o*n,t[11]=c*i-u*n,t},Dt.rotateY=function(t,e,r){var n=Math.sin(r),i=Math.cos(r),a=e[0],s=e[1],o=e[2],u=e[3],f=e[8],h=e[9],l=e[10],c=e[11];return e!==t&&(t[4]=e[4],t[5]=e[5],t[6]=e[6],t[7]=e[7],t[12]=e[12],t[13]=e[13],t[14]=e[14],t[15]=e[15]),t[0]=a*i-f*n,t[1]=s*i-h*n,t[2]=o*i-l*n,t[3]=u*i-c*n,t[8]=a*n+f*i,t[9]=s*n+h*i,t[10]=o*n+l*i,t[11]=u*n+c*i,t},Dt.rotateZ=function(t,e,r){var n=Math.sin(r),i=Math.cos(r),a=e[0],s=e[1],o=e[2],u=e[3],f=e[4],h=e[5],l=e[6],c=e[7];return e!==t&&(t[8]=e[8],t[9]=e[9],t[10]=e[10],t[11]=e[11],t[12]=e[12],t[13]=e[13],t[14]=e[14],t[15]=e[15]),t[0]=a*i+f*n,t[1]=s*i+h*n,t[2]=o*i+l*n,t[3]=u*i+c*n,t[4]=f*i-a*n,t[5]=h*i-s*n,t[6]=l*i-o*n,t[7]=c*i-u*n,t},Dt.fromRotationTranslation=function(t,e,r){var n=e[0],i=e[1],a=e[2],s=e[3],o=n+n,u=i+i,f=a+a,h=n*o,l=n*u,c=n*f,d=i*u,_=i*f,v=a*f,p=s*o,m=s*u,y=s*f;return t[0]=1-(d+v),t[1]=l+y,t[2]=c-m,t[3]=0,t[4]=l-y,t[5]=1-(h+v),t[6]=_+p,t[7]=0,t[8]=c+m,t[9]=_-p,t[10]=1-(h+d),t[11]=0,t[12]=r[0],t[13]=r[1],t[14]=r[2],t[15]=1,t},Dt.fromQuat=function(t,e){var r=e[0],n=e[1],i=e[2],a=e[3],s=r+r,o=n+n,u=i+i,f=r*s,h=n*s,l=n*o,c=i*s,d=i*o,_=i*u,v=a*s,p=a*o,m=a*u;return t[0]=1-l-_,t[1]=h+m,t[2]=c-p,t[3]=0,t[4]=h-m,t[5]=1-f-_,t[6]=d+v,t[7]=0,t[8]=c+p,t[9]=d-v,t[10]=1-f-l,t[11]=0,t[12]=0,t[13]=0,t[14]=0,t[15]=1,t},Dt.frustum=function(t,e,r,n,i,a,s){var o=1/(r-e),u=1/(i-n),f=1/(a-s);return t[0]=2*a*o,t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=2*a*u,t[6]=0,t[7]=0,t[8]=(r+e)*o,t[9]=(i+n)*u,t[10]=(s+a)*f,t[11]=-1,t[12]=0,t[13]=0,t[14]=s*a*2*f,t[15]=0,t},Dt.perspective=function(t,e,r,n,i){var a=1/Math.tan(e/2),s=1/(n-i);return t[0]=a/r,t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=a,t[6]=0,t[7]=0,t[8]=0,t[9]=0,t[10]=(i+n)*s,t[11]=-1,t[12]=0,t[13]=0,t[14]=2*i*n*s,t[15]=0,t},Dt.ortho=function(t,e,r,n,i,a,s){var o=1/(e-r),u=1/(n-i),f=1/(a-s);return t[0]=-2*o,t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=-2*u,t[6]=0,t[7]=0,t[8]=0,t[9]=0,t[10]=2*f,t[11]=0,t[12]=(e+r)*o,t[13]=(i+n)*u,t[14]=(s+a)*f,t[15]=1,t},Dt.lookAt=function(t,e,r,n){var i,a,s,o,u,f,h,l,c,d,_=e[0],v=e[1],p=e[2],m=n[0],y=n[1],g=n[2],b=r[0],E=r[1],x=r[2];return Math.abs(_-b)<1e-6&&Math.abs(v-E)<1e-6&&Math.abs(p-x)<1e-6?Dt.identity(t):(h=_-b,l=v-E,c=p-x,i=y*(c*=d=1/Math.sqrt(h*h+l*l+c*c))-g*(l*=d),a=g*(h*=d)-m*c,s=m*l-y*h,(d=Math.sqrt(i*i+a*a+s*s))?(i*=d=1/d,a*=d,s*=d):(i=0,a=0,s=0),o=l*s-c*a,u=c*i-h*s,f=h*a-l*i,(d=Math.sqrt(o*o+u*u+f*f))?(o*=d=1/d,u*=d,f*=d):(o=0,u=0,f=0),t[0]=i,t[1]=o,t[2]=h,t[3]=0,t[4]=a,t[5]=u,t[6]=l,t[7]=0,t[8]=s,t[9]=f,t[10]=c,t[11]=0,t[12]=-(i*_+a*v+s*p),t[13]=-(o*_+u*v+f*p),t[14]=-(h*_+l*v+c*p),t[15]=1,t)},Dt.frob=function(t){return Math.sqrt(Math.pow(t[0],2)+Math.pow(t[1],2)+Math.pow(t[2],2)+Math.pow(t[3],2)+Math.pow(t[4],2)+Math.pow(t[5],2)+Math.pow(t[6],2)+Math.pow(t[7],2)+Math.pow(t[8],2)+Math.pow(t[9],2)+Math.pow(t[10],2)+Math.pow(t[11],2)+Math.pow(t[12],2)+Math.pow(t[13],2)+Math.pow(t[14],2)+Math.pow(t[15],2))};var kt=Dt,Lt={create:function(){var t=new H(3);return t[0]=0,t[1]=0,t[2]=0,t},clone:function(t){var e=new H(3);return e[0]=t[0],e[1]=t[1],e[2]=t[2],e},fromValues:function(t,e,r){var n=new H(3);return n[0]=t,n[1]=e,n[2]=r,n},copy:function(t,e){return t[0]=e[0],t[1]=e[1],t[2]=e[2],t},set:function(t,e,r,n){return t[0]=e,t[1]=r,t[2]=n,t},add:function(t,e,r){return t[0]=e[0]+r[0],t[1]=e[1]+r[1],t[2]=e[2]+r[2],t},subtract:function(t,e,r){return t[0]=e[0]-r[0],t[1]=e[1]-r[1],t[2]=e[2]-r[2],t}};Lt.sub=Lt.subtract,Lt.multiply=function(t,e,r){return t[0]=e[0]*r[0],t[1]=e[1]*r[1],t[2]=e[2]*r[2],t},Lt.mul=Lt.multiply,Lt.divide=function(t,e,r){return t[0]=e[0]/r[0],t[1]=e[1]/r[1],t[2]=e[2]/r[2],t},Lt.div=Lt.divide,Lt.min=function(t,e,r){return t[0]=Math.min(e[0],r[0]),t[1]=Math.min(e[1],r[1]),t[2]=Math.min(e[2],r[2]),t},Lt.max=function(t,e,r){return t[0]=Math.max(e[0],r[0]),t[1]=Math.max(e[1],r[1]),t[2]=Math.max(e[2],r[2]),t},Lt.scale=function(t,e,r){return t[0]=e[0]*r,t[1]=e[1]*r,t[2]=e[2]*r,t},Lt.scaleAndAdd=function(t,e,r,n){return t[0]=e[0]+r[0]*n,t[1]=e[1]+r[1]*n,t[2]=e[2]+r[2]*n,t},Lt.distance=function(t,e){var r=e[0]-t[0],n=e[1]-t[1],i=e[2]-t[2];return Math.sqrt(r*r+n*n+i*i)},Lt.dist=Lt.distance,Lt.squaredDistance=function(t,e){var r=e[0]-t[0],n=e[1]-t[1],i=e[2]-t[2];return r*r+n*n+i*i},Lt.sqrDist=Lt.squaredDistance,Lt.length=function(t){var e=t[0],r=t[1],n=t[2];return Math.sqrt(e*e+r*r+n*n)},Lt.len=Lt.length,Lt.squaredLength=function(t){var e=t[0],r=t[1],n=t[2];return e*e+r*r+n*n},Lt.sqrLen=Lt.squaredLength,Lt.negate=function(t,e){return t[0]=-e[0],t[1]=-e[1],t[2]=-e[2],t},Lt.inverse=function(t,e){return t[0]=1/e[0],t[1]=1/e[1],t[2]=1/e[2],t},Lt.normalize=function(t,e){var r=e[0],n=e[1],i=e[2],a=r*r+n*n+i*i;return a>0&&(a=1/Math.sqrt(a),t[0]=e[0]*a,t[1]=e[1]*a,t[2]=e[2]*a),t},Lt.dot=function(t,e){return t[0]*e[0]+t[1]*e[1]+t[2]*e[2]},Lt.cross=function(t,e,r){var n=e[0],i=e[1],a=e[2],s=r[0],o=r[1],u=r[2];return t[0]=i*u-a*o,t[1]=a*s-n*u,t[2]=n*o-i*s,t},Lt.lerp=function(t,e,r,n){var i=e[0],a=e[1],s=e[2];return t[0]=i+n*(r[0]-i),t[1]=a+n*(r[1]-a),t[2]=s+n*(r[2]-s),t},Lt.random=function(t,e){e=e||1;var r=2*Z()*Math.PI,n=2*Z()-1,i=Math.sqrt(1-n*n)*e;return t[0]=Math.cos(r)*i,t[1]=Math.sin(r)*i,t[2]=n*e,t},Lt.transformMat4=function(t,e,r){var n=e[0],i=e[1],a=e[2],s=r[3]*n+r[7]*i+r[11]*a+r[15];return s=s||1,t[0]=(r[0]*n+r[4]*i+r[8]*a+r[12])/s,t[1]=(r[1]*n+r[5]*i+r[9]*a+r[13])/s,t[2]=(r[2]*n+r[6]*i+r[10]*a+r[14])/s,t},Lt.transformMat3=function(t,e,r){var n=e[0],i=e[1],a=e[2];return t[0]=n*r[0]+i*r[3]+a*r[6],t[1]=n*r[1]+i*r[4]+a*r[7],t[2]=n*r[2]+i*r[5]+a*r[8],t},Lt.transformQuat=function(t,e,r){var n=e[0],i=e[1],a=e[2],s=r[0],o=r[1],u=r[2],f=r[3],h=f*n+o*a-u*i,l=f*i+u*n-s*a,c=f*a+s*i-o*n,d=-s*n-o*i-u*a;return t[0]=h*f+d*-s+l*-u-c*-o,t[1]=l*f+d*-o+c*-s-h*-u,t[2]=c*f+d*-u+h*-o-l*-s,t},Lt.rotateX=function(t,e,r,n){var i=[],a=[];return i[0]=e[0]-r[0],i[1]=e[1]-r[1],i[2]=e[2]-r[2],a[0]=i[0],a[1]=i[1]*Math.cos(n)-i[2]*Math.sin(n),a[2]=i[1]*Math.sin(n)+i[2]*Math.cos(n),t[0]=a[0]+r[0],t[1]=a[1]+r[1],t[2]=a[2]+r[2],t},Lt.rotateY=function(t,e,r,n){var i=[],a=[];return i[0]=e[0]-r[0],i[1]=e[1]-r[1],i[2]=e[2]-r[2],a[0]=i[2]*Math.sin(n)+i[0]*Math.cos(n),a[1]=i[1],a[2]=i[2]*Math.cos(n)-i[0]*Math.sin(n),t[0]=a[0]+r[0],t[1]=a[1]+r[1],t[2]=a[2]+r[2],t},Lt.rotateZ=function(t,e,r,n){var i=[],a=[];return i[0]=e[0]-r[0],i[1]=e[1]-r[1],i[2]=e[2]-r[2],a[0]=i[0]*Math.cos(n)-i[1]*Math.sin(n),a[1]=i[0]*Math.sin(n)+i[1]*Math.cos(n),a[2]=i[2],t[0]=a[0]+r[0],t[1]=a[1]+r[1],t[2]=a[2]+r[2],t},Lt.forEach=function(){var t=Lt.create();return function(e,r,n,i,a,s){var o,u;for(r||(r=3),n||(n=0),u=i?Math.min(i*r+n,e.length):e.length,o=n;o<u;o+=r)t[0]=e[o],t[1]=e[o+1],t[2]=e[o+2],a(t,t,s),e[o]=t[0],e[o+1]=t[1],e[o+2]=t[2];return e}}(),Lt.angle=function(t,e){var r=Lt.fromValues(t[0],t[1],t[2]),n=Lt.fromValues(e[0],e[1],e[2]);Lt.normalize(r,r),Lt.normalize(n,n);var i=Lt.dot(r,n);return i>1?0:Math.acos(i)};var Ut=Lt;Ct.import("@export clay.prez.vertex\nuniform mat4 WVP : WORLDVIEWPROJECTION;\nattribute vec3 pos : POSITION;\nattribute vec2 uv : TEXCOORD_0;\n@import clay.chunk.skinning_header\nvarying vec2 v_Uv;\nvoid main()\n{\n vec3 P = pos;\n#ifdef SKINNING\n @import clay.chunk.skin_matrix\n P = (skinMatrixWS * vec4(pos, 1.0)).xyz;\n#endif\n gl_Position = WVP * vec4(P, 1.0);\n v_Uv = uv;\n}\n@end\n@export clay.prez.fragment\nuniform sampler2D alphaMap;\nuniform float alphaCutoff: 0.0;\nvarying vec2 v_Uv;\nvoid main()\n{\n if (alphaCutoff > 0.0) {\n if (texture2D(alphaMap, v_Uv).a <= alphaCutoff) {\n discard;\n }\n }\n gl_FragColor = vec4(0.0,0.0,0.0,1.0);\n}\n@end");var Vt=kt.create,Wt={};function Bt(t){return t.material}function Ft(t,e,r){return e.uniforms[r].value}function jt(t,e,r,n){return r!==n}function qt(){}var zt={float:A,byte:x,ubyte:S,short:O,ushort:R};var Jt=c.extend(function(){return{canvas:null,_width:100,_height:100,devicePixelRatio:window&&window.devicePixelRatio||1,clearColor:[0,0,0,0],clearBit:17664,alpha:!0,depth:!0,stencil:!1,antialias:!0,premultipliedAlpha:!0,preserveDrawingBuffer:!1,throwError:!0,gl:null,viewport:{},createCanvas:function(){return document.createElement("canvas")},__currentFrameBuffer:null,_viewportStack:[],_clearStack:[],_sceneRendering:null}},function(){this.canvas||(this.canvas=this.createCanvas());var t=this.canvas;try{var e={alpha:this.alpha,depth:this.depth,stencil:this.stencil,antialias:this.antialias,premultipliedAlpha:this.premultipliedAlpha,preserveDrawingBuffer:this.preserveDrawingBuffer};if(this.gl=t.getContext("webgl",e)||t.getContext("experimental-webgl",e),!this.gl)throw new Error;this._glinfo=new v(this.gl),this.gl.targetRenderer&&console.error("Already created a renderer"),this.gl.targetRenderer=this,this.resize()}catch(t){throw"Error creating WebGL Context "+t}this._programMgr=new _t(this),this._placeholderTexture=new function(t){var e,r=t.createCanvas();r.width=r.height=1,r.getContext("2d"),this.bind=function(t){var n=t.gl,i=!e;i&&(e=n.createTexture()),n.bindTexture(n.TEXTURE_2D,e),i&&n.texImage2D(n.TEXTURE_2D,0,n.RGBA,n.RGBA,n.UNSIGNED_BYTE,r)},this.unbind=function(t){t.gl.bindTexture(t.gl.TEXTURE_2D,null)},this.isRenderable=function(){return!0}}(this)},{resize:function(t,e){var r=this.canvas,n=this.devicePixelRatio;null!=t?(r.style.width=t+"px",r.style.height=e+"px",r.width=t*n,r.height=e*n,this._width=t,this._height=e):(this._width=r.width/n,this._height=r.height/n),this.setViewport(0,0,this._width,this._height)},getWidth:function(){return this._width},getHeight:function(){return this._height},getViewportAspect:function(){var t=this.viewport;return t.width/t.height},setDevicePixelRatio:function(t){this.devicePixelRatio=t,this.resize(this._width,this._height)},getDevicePixelRatio:function(){return this.devicePixelRatio},getGLExtension:function(t){return this._glinfo.getExtension(t)},getGLParameter:function(t){return this._glinfo.getParameter(t)},setViewport:function(t,e,r,n,i){if("object"==typeof t){var a=t;t=a.x,e=a.y,r=a.width,n=a.height,i=a.devicePixelRatio}i=i||this.devicePixelRatio,this.gl.viewport(t*i,e*i,r*i,n*i),this.viewport={x:t,y:e,width:r,height:n,devicePixelRatio:i}},saveViewport:function(){this._viewportStack.push(this.viewport)},restoreViewport:function(){this._viewportStack.length>0&&this.setViewport(this._viewportStack.pop())},saveClear:function(){this._clearStack.push({clearBit:this.clearBit,clearColor:this.clearColor})},restoreClear:function(){if(this._clearStack.length>0){var t=this._clearStack.pop();this.clearColor=t.clearColor,this.clearBit=t.clearBit}},bindSceneRendering:function(t){this._sceneRendering=t},render:function(t,e,r,n){var i=this.gl,a=this.clearColor;if(this.clearBit){i.colorMask(!0,!0,!0,!0),i.depthMask(!0);var s=this.viewport,o=!1,u=s.devicePixelRatio;(s.width!==this._width||s.height!==this._height||u&&u!==this.devicePixelRatio||s.x||s.y)&&(o=!0,i.enable(i.SCISSOR_TEST),i.scissor(s.x*u,s.y*u,s.width*u,s.height*u)),i.clearColor(a[0],a[1],a[2],a[3]),i.clear(this.clearBit),o&&i.disable(i.SCISSOR_TEST)}if(r||t.update(!1),t.updateLights(),e=e||t.getMainCamera()){e.update();var f=t.updateRenderList(e,!0);this._sceneRendering=t;var h=f.opaque,l=f.transparent,c=t.material;t.trigger("beforerender",this,t,e,f),n?(this.renderPreZ(h,t,e),i.depthFunc(i.LEQUAL)):i.depthFunc(i.LESS);for(var d=Vt(),_=Ut.create(),v=0;v<l.length;v++){var p=l[v];kt.multiplyAffine(d,e.viewMatrix.array,p.worldTransform.array),Ut.transformMat4(_,p.position.array,d),p.__depth=_[2]}this.renderPass(h,e,{getMaterial:function(t){return c||t.material},sortCompare:this.opaqueSortCompare}),this.renderPass(l,e,{getMaterial:function(t){return c||t.material},sortCompare:this.transparentSortCompare}),t.trigger("afterrender",this,t,e,f),this._sceneRendering=null}else console.error("Can't find camera in the scene.")},getProgram:function(t,e,r){return e=e||t.material,this._programMgr.getProgram(t,e,r)},validateProgram:function(t){if(t.__error){var e=t.__error;if(Wt[t.__uid__])return;if(Wt[t.__uid__]=!0,this.throwError)throw new Error(e);this.trigger("error",e)}},updatePrograms:function(t,e,r){var n=r&&r.getMaterial||Bt;e=e||null;for(var i=0;i<t.length;i++){var a=t[i],s=n.call(this,a);if(i>0){var o=t[i-1],u=o.joints?o.joints.length:0;if((a.joints?a.joints.length:0)===u&&a.material===o.material&&a.lightGroup===o.lightGroup){a.__program=o.__program;continue}}var f=this._programMgr.getProgram(a,s,e);this.validateProgram(f),a.__program=f}},renderPass:function(t,e,r){this.trigger("beforerenderpass",this,t,e,r),(r=r||{}).getMaterial=r.getMaterial||Bt,r.getUniform=r.getUniform||Ft,r.isMaterialChanged=r.isMaterialChanged||jt,r.beforeRender=r.beforeRender||qt,r.afterRender=r.afterRender||qt,this.updatePrograms(t,this._sceneRendering,r),r.sortCompare&&t.sort(r.sortCompare);var n=this.viewport,i=n.devicePixelRatio,a=[n.x*i,n.y*i,n.width*i,n.height*i],s=this.devicePixelRatio,o=this.__currentFrameBuffer?[this.__currentFrameBuffer.getTextureWidth(),this.__currentFrameBuffer.getTextureHeight()]:[this._width*s,this._height*s],u=[a[2],a[3]],f=Date.now();e?(kt.copy(Gt.VIEW,e.viewMatrix.array),kt.copy(Gt.PROJECTION,e.projectionMatrix.array),kt.copy(Gt.VIEWINVERSE,e.worldTransform.array)):(kt.identity(Gt.VIEW),kt.identity(Gt.PROJECTION),kt.identity(Gt.VIEWINVERSE)),kt.multiply(Gt.VIEWPROJECTION,Gt.PROJECTION,Gt.VIEW),kt.invert(Gt.PROJECTIONINVERSE,Gt.PROJECTION),kt.invert(Gt.VIEWPROJECTIONINVERSE,Gt.VIEWPROJECTION);for(var h,l,c,d,_,v,p,m,y,g,b,E,x=this.gl,S=this._sceneRendering,O=this.getGLExtension("OES_vertex_array_object"),R=0;R<t.length;R++){var A,I=t[R],T=null!=I.worldTransform;if(!r.ifRender||r.ifRender(I)){T&&(A=I.isSkinnedMesh&&I.isSkinnedMesh()?Gt.IDENTITY:I.worldTransform.array);var M=I.geometry,w=r.getMaterial.call(this,I),N=I.__program,P=w.shader,C=M.__uid__+"-"+N.__uid__,D=C!==g;g=C,D&&O&&O.bindVertexArrayOES(null),T&&(kt.copy(Gt.WORLD,A),kt.multiply(Gt.WORLDVIEWPROJECTION,Gt.VIEWPROJECTION,A),kt.multiplyAffine(Gt.WORLDVIEW,Gt.VIEW,A),(P.matrixSemantics.WORLDINVERSE||P.matrixSemantics.WORLDINVERSETRANSPOSE)&&kt.invert(Gt.WORLDINVERSE,A),(P.matrixSemantics.WORLDVIEWINVERSE||P.matrixSemantics.WORLDVIEWINVERSETRANSPOSE)&&kt.invert(Gt.WORLDVIEWINVERSE,Gt.WORLDVIEW),(P.matrixSemantics.WORLDVIEWPROJECTIONINVERSE||P.matrixSemantics.WORLDVIEWPROJECTIONINVERSETRANSPOSE)&&kt.invert(Gt.WORLDVIEWPROJECTIONINVERSE,Gt.WORLDVIEWPROJECTION)),I.beforeRender&&I.beforeRender(this),r.beforeRender.call(this,I,w,h);var k=N!==l;k?(N.bind(this),N.setUniformOfSemantic(x,"VIEWPORT",a),N.setUniformOfSemantic(x,"WINDOW_SIZE",o),e&&(N.setUniformOfSemantic(x,"NEAR",e.near),N.setUniformOfSemantic(x,"FAR",e.far)),N.setUniformOfSemantic(x,"DEVICEPIXELRATIO",i),N.setUniformOfSemantic(x,"TIME",f),N.setUniformOfSemantic(x,"VIEWPORT_SIZE",u),S&&S.setLightUniforms(N,I.lightGroup,this)):N=l,(k||r.isMaterialChanged(I,c,w,h))&&(w.depthTest!==d&&(w.depthTest?x.enable(x.DEPTH_TEST):x.disable(x.DEPTH_TEST),d=w.depthTest),w.depthMask!==_&&(x.depthMask(w.depthMask),_=w.depthMask),w.transparent!==y&&(w.transparent?x.enable(x.BLEND):x.disable(x.BLEND),y=w.transparent),w.transparent&&(w.blend?w.blend(x):(x.blendEquationSeparate(x.FUNC_ADD,x.FUNC_ADD),x.blendFuncSeparate(x.SRC_ALPHA,x.ONE_MINUS_SRC_ALPHA,x.ONE,x.ONE_MINUS_SRC_ALPHA))),E=this._bindMaterial(I,w,N,c||null,h||null,l||null,r.getUniform),h=w);var L=P.matrixSemanticKeys;if(T)for(var U=0;U<L.length;U++){var V=L[U],W=P.matrixSemantics[V],B=Gt[V];if(W.isTranspose){var F=Gt[W.semanticNoTranspose];kt.transpose(B,F)}N.setUniform(x,W.type,W.symbol,B)}I.cullFace!==p&&(p=I.cullFace,x.cullFace(p)),I.frontFace!==m&&(m=I.frontFace,x.frontFace(m)),I.culling!==v&&((v=I.culling)?x.enable(x.CULL_FACE):x.disable(x.CULL_FACE)),this._updateSkeleton(I,N,E),D&&(b=this._bindVAO(O,P,M,N)),this._renderObject(I,b),r.afterRender(this,I),I.afterRender&&I.afterRender(this),l=N,c=I}}O&&O.bindVertexArrayOES(null),this.trigger("afterrenderpass",this,t,e,r)},getMaxJointNumber:function(){return this._glinfo.getMaxJointNumber()},_updateSkeleton:function(t,e,r){var n=this.gl,i=t.skeleton;if(i)if(i.update(),t.joints.length>this._glinfo.getMaxJointNumber()){var a=i.getSubSkinMatricesTexture(t.__uid__,t.joints);e.useTextureSlot(this,a,r),e.setUniform(n,"1i","skinMatricesTexture",r),e.setUniform(n,"1f","skinMatricesTextureSize",a.width)}else{var s=i.getSubSkinMatrices(t.__uid__,t.joints);e.setUniformOfSemantic(n,"SKIN_MATRIX",s)}},_renderObject:function(t,e){var r=this.gl,n=t.geometry,i=t.mode;if(null==i&&(i=4),e.indicesBuffer){var a=this.getGLExtension("OES_element_index_uint")&&n.indices instanceof Uint32Array?r.UNSIGNED_INT:r.UNSIGNED_SHORT;r.drawElements(i,e.indicesBuffer.count,a,0)}else r.drawArrays(i,0,n.vertexCount)},_bindMaterial:function(t,e,r,n,i,a,s){for(var o=this.gl,u=a===r,f=r.currentTextureSlot(),h=e.getEnabledUniforms(),l=e.getTextureUniforms(),c=this._placeholderTexture,d=0;d<l.length;d++){var _=s(t,e,m=l[d]);if("t"===(p=e.uniforms[m].type)&&_)_.__slot=-1;else if("tv"===p)for(var v=0;v<_.length;v++)_[v]&&(_[v].__slot=-1)}c.__slot=-1;for(d=0;d<h.length;d++){var p,m=h[d],y=e.uniforms[m];_=s(t,e,m);if("t"===(p=y.type)&&(_&&_.isRenderable()||(_=c)),i&&u){var g=s(n,i,m);if("t"===p&&(g&&g.isRenderable()||(g=c)),g===_){if("t"===y.type)r.takeCurrentTextureSlot(this,null);else if("tv"===p&&_)for(v=0;v<_.length;v++)r.takeCurrentTextureSlot(this,null);continue}}if(null!=_)if("t"===p)if(_.__slot<0){var b=r.currentTextureSlot();r.setUniform(o,"1i",m,b)&&(r.takeCurrentTextureSlot(this,_),_.__slot=b)}else r.setUniform(o,"1i",m,_.__slot);else if(Array.isArray(_)){if(0===_.length)continue;if("tv"===p){if(!r.hasUniform(m))continue;var E=[];for(v=0;v<_.length;v++){var x=_[v];if(x.__slot<0){b=r.currentTextureSlot();E.push(b),r.takeCurrentTextureSlot(this,x),x.__slot=b}else E.push(x.__slot)}r.setUniform(o,"1iv",m,E)}else r.setUniform(o,y.type,m,_)}else r.setUniform(o,y.type,m,_)}var S=r.currentTextureSlot();return r.resetTextureSlot(f),S},_bindVAO:function(t,e,r,n){var i=!r.dynamic,a=this.gl,s=this.__uid__+"-"+n.__uid__,o=r.__vaoCache[s];if(!o){var u=r.getBufferChunks(this);if(!u||!u.length)return;for(var f=u[0],h=f.attributeBuffers,l=f.indicesBuffer,c=[],d=[],_=0;_<h.length;_++){var v,p=(x=h[_]).name,m=x.semantic;if(m){var y=e.attributeSemantics[m];v=y&&y.symbol}else v=p;v&&n.attributes[v]&&(c.push(x),d.push(v))}o=new function(t,e,r){this.availableAttributes=t,this.availableAttributeSymbols=e,this.indicesBuffer=r,this.vao=null}(c,d,l),i&&(r.__vaoCache[s]=o)}var g=!0;t&&i&&(null==o.vao?o.vao=t.createVertexArrayOES():g=!1,t.bindVertexArrayOES(o.vao));c=o.availableAttributes,l=o.indicesBuffer;if(g){var b=n.enableAttributes(this,o.availableAttributeSymbols,t&&i&&o);for(_=0;_<c.length;_++){var E=b[_];if(-1!==E){var x,S=(x=c[_]).buffer,O=x.size,R=zt[x.type]||a.FLOAT;a.bindBuffer(a.ARRAY_BUFFER,S),a.vertexAttribPointer(E,O,R,!1,0,0)}}r.isUseIndices()&&a.bindBuffer(a.ELEMENT_ARRAY_BUFFER,l.buffer)}return o},renderPreZ:function(t,e,r){var n=this.gl,i=this._prezMaterial||new K({shader:new Ct(Ct.source("clay.prez.vertex"),Ct.source("clay.prez.fragment"))});this._prezMaterial=i,n.colorMask(!1,!1,!1,!1),n.depthMask(!0),this.renderPass(t,r,{ifRender:function(t){return!t.ignorePreZ},isMaterialChanged:function(t,e){var r=t.material,n=e.material;return r.get("diffuseMap")!==n.get("diffuseMap")||(r.get("alphaCutoff")||0)!==(n.get("alphaCutoff")||0)},getUniform:function(t,e,r){return"alphaMap"===r?t.material.get("diffuseMap"):"alphaCutoff"===r?t.material.isDefined("fragment","ALPHA_TEST")&&t.material.get("diffuseMap")&&t.material.get("alphaCutoff")||0:e.get(r)},getMaterial:function(){return i},sort:this.opaqueSortCompare}),n.colorMask(!0,!0,!0,!0),n.depthMask(!0)},disposeScene:function(t){this.disposeNode(t,!0,!0),t.dispose()},disposeNode:function(t,e,r){t.getParent()&&t.getParent().remove(t);var n={};t.traverse(function(t){var i=t.material;if(t.geometry&&e&&t.geometry.dispose(this),r&&i&&!n[i.__uid__]){for(var a=i.getTextureUniforms(),s=0;s<a.length;s++){var o=a[s],u=i.uniforms[o].value,f=i.uniforms[o].type;if(u)if("t"===f)u.dispose&&u.dispose(this);else if("tv"===f)for(var h=0;h<u.length;h++)u[h]&&u[h].dispose&&u[h].dispose(this)}n[i.__uid__]=!0}t.dispose&&t.dispose(this)},this)},disposeGeometry:function(t){t.dispose(this)},disposeTexture:function(t){t.dispose(this)},disposeFrameBuffer:function(t){t.dispose(this)},dispose:function(){},screenToNDC:function(t,e,r){r||(r=new et),e=this._height-e;var n=this.viewport,i=r.array;return i[0]=(t-n.x)/n.width,i[0]=2*i[0]-1,i[1]=(e-n.y)/n.height,i[1]=2*i[1]-1,r}});Jt.opaqueSortCompare=Jt.prototype.opaqueSortCompare=function(t,e){return t.renderOrder===e.renderOrder?t.__program===e.__program?t.material===e.material?t.geometry.__uid__-e.geometry.__uid__:t.material.__uid__-e.material.__uid__:t.__program&&e.__program?t.__program.__uid__-e.__program.__uid__:0:t.renderOrder-e.renderOrder},Jt.transparentSortCompare=Jt.prototype.transparentSortCompare=function(t,e){return t.renderOrder===e.renderOrder?t.__depth===e.__depth?t.__program===e.__program?t.material===e.material?t.geometry.__uid__-e.geometry.__uid__:t.material.__uid__-e.material.__uid__:t.__program&&e.__program?t.__program.__uid__-e.__program.__uid__:0:t.__depth-e.__depth:t.renderOrder-e.renderOrder};var Gt={IDENTITY:Vt(),WORLD:Vt(),VIEW:Vt(),PROJECTION:Vt(),WORLDVIEW:Vt(),VIEWPROJECTION:Vt(),WORLDVIEWPROJECTION:Vt(),WORLDINVERSE:Vt(),VIEWINVERSE:Vt(),PROJECTIONINVERSE:Vt(),WORLDVIEWINVERSE:Vt(),VIEWPROJECTIONINVERSE:Vt(),WORLDVIEWPROJECTIONINVERSE:Vt(),WORLDTRANSPOSE:Vt(),VIEWTRANSPOSE:Vt(),PROJECTIONTRANSPOSE:Vt(),WORLDVIEWTRANSPOSE:Vt(),VIEWPROJECTIONTRANSPOSE:Vt(),WORLDVIEWPROJECTIONTRANSPOSE:Vt(),WORLDINVERSETRANSPOSE:Vt(),VIEWINVERSETRANSPOSE:Vt(),PROJECTIONINVERSETRANSPOSE:Vt(),WORLDVIEWINVERSETRANSPOSE:Vt(),VIEWPROJECTIONINVERSETRANSPOSE:Vt(),WORLDVIEWPROJECTIONINVERSETRANSPOSE:Vt()};Jt.COLOR_BUFFER_BIT=y,Jt.DEPTH_BUFFER_BIT=p,Jt.STENCIL_BUFFER_BIT=m;var Xt=Jt,Kt=function(){this._contextId=0,this._caches=[],this._context={}};(Kt.prototype={use:function(t,e){var r=this._caches;r[t]||(r[t]={},e&&(r[t]=e())),this._contextId=t,this._context=r[t]},put:function(t,e){this._context[t]=e},get:function(t){return this._context[t]},dirty:function(t){var e="__dt__"+(t=t||"");this.put(e,!0)},dirtyAll:function(t){for(var e="__dt__"+(t=t||""),r=this._caches,n=0;n<r.length;n++)r[n]&&(r[n][e]=!0)},fresh:function(t){var e="__dt__"+(t=t||"");this.put(e,!1)},freshAll:function(t){for(var e="__dt__"+(t=t||""),r=this._caches,n=0;n<r.length;n++)r[n]&&(r[n][e]=!1)},isDirty:function(t){var e="__dt__"+(t=t||""),r=this._context;return!r.hasOwnProperty(e)||!0===r[e]},deleteContext:function(t){delete this._caches[t],this._context={}},delete:function(t){delete this._context[t]},clearAll:function(){this._caches={}},getContext:function(){return this._context},eachContext:function(t,e){Object.keys(this._caches).forEach(function(r){t&&t.call(e,r)})},miss:function(t){return!this._context.hasOwnProperty(t)}}).constructor=Kt;var Ht=Kt;function Zt(t){return{byte:at.Int8Array,ubyte:at.Uint8Array,short:at.Int16Array,ushort:at.Uint16Array}[t]||at.Float32Array}function Yt(t){return"attr_"+t}function Qt(t,e,r,n){switch(this.name=t,this.type=e,this.size=r,this.semantic=n||"",this.value=null,r){case 1:this.get=function(t){return this.value[t]},this.set=function(t,e){this.value[t]=e},this.copy=function(t,e){this.value[t]=this.value[t]};break;case 2:this.get=function(t,e){var r=this.value;return e[0]=r[2*t],e[1]=r[2*t+1],e},this.set=function(t,e){var r=this.value;r[2*t]=e[0],r[2*t+1]=e[1]},this.copy=function(t,e){var r=this.value;e*=2,r[t*=2]=r[e],r[t+1]=r[e+1]};break;case 3:this.get=function(t,e){var r=3*t,n=this.value;return e[0]=n[r],e[1]=n[r+1],e[2]=n[r+2],e},this.set=function(t,e){var r=3*t,n=this.value;n[r]=e[0],n[r+1]=e[1],n[r+2]=e[2]},this.copy=function(t,e){var r=this.value;e*=3,r[t*=3]=r[e],r[t+1]=r[e+1],r[t+2]=r[e+2]};break;case 4:this.get=function(t,e){var r=this.value,n=4*t;return e[0]=r[n],e[1]=r[n+1],e[2]=r[n+2],e[3]=r[n+3],e},this.set=function(t,e){var r=this.value,n=4*t;r[n]=e[0],r[n+1]=e[1],r[n+2]=e[2],r[n+3]=e[3]},this.copy=function(t,e){var r=this.value;e*=4,r[t*=4]=r[e],r[t+1]=r[e+1],r[t+2]=r[e+2],r[t+3]=r[e+3]}}}function $t(t,e,r,n,i){this.name=t,this.type=e,this.buffer=r,this.size=n,this.semantic=i,this.symbol="",this.needsRemove=!1}function te(t){this.buffer=t,this.count=0}Qt.prototype.init=function(t){if(!this.value||this.value.length!=t*this.size){var e=Zt(this.type);this.value=new e(t*this.size)}},Qt.prototype.fromArray=function(t){var e,r=Zt(this.type);if(t[0]&&t[0].length){var n=0,i=this.size;e=new r(t.length*i);for(var a=0;a<t.length;a++)for(var s=0;s<i;s++)e[n++]=t[a][s]}else e=new r(t);this.value=e},Qt.prototype.clone=function(t){var e=new Qt(this.name,this.type,this.size,this.semantic);return t&&console.warn("todo"),e};var ee=c.extend(function(){return{attributes:{},indices:null,dynamic:!0,_enabledAttributes:null,__used:0}},function(){this._cache=new Ht,this._attributeList=Object.keys(this.attributes),this.__vaoCache={}},{mainAttribute:"",pick:null,pickByRay:null,dirty:function(){for(var t=this.getEnabledAttributes(),e=0;e<t.length;e++)this.dirtyAttribute(t[e]);this.dirtyIndices(),this._enabledAttributes=null,this._cache.dirty("any")},dirtyIndices:function(){this._cache.dirtyAll("indices")},dirtyAttribute:function(t){this._cache.dirtyAll(Yt(t)),this._cache.dirtyAll("attributes")},getTriangleIndices:function(t,e){if(t<this.triangleCount&&t>=0){e||(e=[]);var r=this.indices;return e[0]=r[3*t],e[1]=r[3*t+1],e[2]=r[3*t+2],e}},setTriangleIndices:function(t,e){var r=this.indices;r[3*t]=e[0],r[3*t+1]=e[1],r[3*t+2]=e[2]},isUseIndices:function(){return!!this.indices},initIndicesFromArray:function(t){var e,r=this.vertexCount>65535?at.Uint32Array:at.Uint16Array;if(t[0]&&t[0].length){var n=0;e=new r(3*t.length);for(var i=0;i<t.length;i++)for(var a=0;a<3;a++)e[n++]=t[i][a]}else e=new r(t);this.indices=e},createAttribute:function(t,e,r,n){var i=new Qt(t,e,r,n);return this.attributes[t]&&this.removeAttribute(t),this.attributes[t]=i,this._attributeList.push(t),i},removeAttribute:function(t){var e=this._attributeList,r=e.indexOf(t);return r>=0&&(e.splice(r,1),delete this.attributes[t],!0)},getAttribute:function(t){return this.attributes[t]},getEnabledAttributes:function(){var t=this._enabledAttributes,e=this._attributeList;if(t)return t;for(var r=[],n=this.vertexCount,i=0;i<e.length;i++){var a=e[i],s=this.attributes[a];s.value&&s.value.length===n*s.size&&r.push(a)}return this._enabledAttributes=r,r},getBufferChunks:function(t){var e=this._cache;e.use(t.__uid__);var r=e.isDirty("attributes"),n=e.isDirty("indices");if(r||n){this._updateBuffer(t.gl,r,n);for(var i=this.getEnabledAttributes(),a=0;a<i.length;a++)e.fresh(Yt(i[a]));e.fresh("attributes"),e.fresh("indices")}return e.fresh("any"),e.get("chunks")},_updateBuffer:function(t,e,r){var n=this._cache,i=n.get("chunks"),a=!1;i||((i=[])[0]={attributeBuffers:[],indicesBuffer:null},n.put("chunks",i),a=!0);var s=i[0],o=s.attributeBuffers,u=s.indicesBuffer;if(e||a){var f=this.getEnabledAttributes(),h={};if(!a)for(var l=0;l<o.length;l++)h[o[l].name]=o[l];for(var c=0;c<f.length;c++){var d,_,v=f[c],p=this.attributes[v];a||(d=h[v]),_=d?d.buffer:t.createBuffer(),n.isDirty(Yt(v))&&(t.bindBuffer(t.ARRAY_BUFFER,_),t.bufferData(t.ARRAY_BUFFER,p.value,this.dynamic?E:b)),o[c]=new $t(v,p.type,_,p.size,p.semantic)}for(l=c;l<o.length;l++)t.deleteBuffer(o[l].buffer);o.length=c}this.isUseIndices()&&(r||a)&&(u||(u=new te(t.createBuffer()),s.indicesBuffer=u),u.count=this.indices.length,t.bindBuffer(t.ELEMENT_ARRAY_BUFFER,u.buffer),t.bufferData(t.ELEMENT_ARRAY_BUFFER,this.indices,this.dynamic?E:b))},dispose:function(t){var e=this._cache;e.use(t.__uid__);var r=e.get("chunks");if(r)for(var n=0;n<r.length;n++){for(var i=r[n],a=0;a<i.attributeBuffers.length;a++){var s=i.attributeBuffers[a];t.gl.deleteBuffer(s.buffer)}i.indicesBuffer&&t.gl.deleteBuffer(i.indicesBuffer.buffer)}if(this.__vaoCache){var o=t.getGLExtension("OES_vertex_array_object");for(var u in this.__vaoCache){var f=this.__vaoCache[u].vao;f&&o.deleteVertexArrayOES(f)}}this.__vaoCache={},e.deleteContext(t.__uid__)}});Object.defineProperty&&(Object.defineProperty(ee.prototype,"vertexCount",{enumerable:!1,get:function(){var t=this.attributes[this.mainAttribute];return t||(t=this.attributes[this._attributeList[0]]),t&&t.value?t.value.length/t.size:0}}),Object.defineProperty(ee.prototype,"triangleCount",{enumerable:!1,get:function(){var t=this.indices;return t?t.length/3:0}})),ee.STATIC_DRAW=b,ee.DYNAMIC_DRAW=E,ee.STREAM_DRAW=g,ee.AttributeBuffer=$t,ee.IndicesBuffer=te,ee.Attribute=Qt;var re=ee;const ne=new Xt({canvas:document.getElementById("main")});ne.resize(400,400);const ie=new re;ie.createAttribute("position","float",3),ie.attributes.position.fromArray([[-.5,-.5,0],[.5,-.5,0],[0,.5,0]]);const ae=new K({shader:new Ct("\nattribute vec3 position;\nvoid main() {\n    gl_Position = vec4(position, 1.0);\n}\n","\nvoid main() {\n    gl_FragColor = vec4(0.0, 0.0, 1.0, 1.0);\n}\n")});ne.renderPass([{geometry:ie,material:ae}])},function(t,e,r){t.exports=r(0)}]);